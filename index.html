<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Ping-Pong-Pang｜翌日以降受け取り 注文</title>

<!-- 年末年始の固定休業日（フロント直書き） -->
<script>
  // ISOレンジを配列化（両端含む）
  function dateRangeISO(startISO, endISO){
    const out = [];
    const d0 = new Date(startISO);
    const d1 = new Date(endISO);
    d0.setHours(0,0,0,0); d1.setHours(0,0,0,0);
    for(let d=new Date(d0); d<=d1; d.setDate(d.getDate()+1)){
      out.push([d.getFullYear(), String(d.getMonth()+1).padStart(2,'0'), String(d.getDate()).padStart(2,'0')].join('-'));
    }
    return out;
  }
  // 2025-12-31〜2026-01-02 の3日間を休業
  window.PPP_CLOSED_DATES = [
    ...dateRangeISO('2025-12-31','2026-01-02'),
  ];

  // 非常時の即時反映（コンソールから追加できる）: localStorage.setItem('ppp_closed_override','2025-12-30,2026-01-04')
  const _ovr = (localStorage.getItem('ppp_closed_override')||'')
    .split(',').map(s=>s.trim()).filter(Boolean);
  if(_ovr.length) window.PPP_CLOSED_DATES = [...window.PPP_CLOSED_DATES, ..._ovr];
</script>

<style>
:root{
  --bg:#fafafa;
  --ink:#1f2937;
  --muted:#6b7280;
  --brand:#10b981;
  --brand-ink:#064e3b;
  --border:#e5e7eb;
  --wrap:1080px;
  --btn-h:44px;
  --btn-radius:12px;
  --z-sticky:50;
}
*{box-sizing:border-box}
body{ margin:0; font-family:system-ui,-apple-system,"Segoe UI","Hiragino Kaku Gothic ProN","Meiryo",sans-serif; color:var(--ink); background:#fff }
.wrap{ max-width:var(--wrap); width:100%; margin:0 auto; padding:0 16px }

/* ===== ヘッダー ===== */
header{ background:#fff; border-bottom:1px solid var(--border) }
.header-in{ display:flex; align-items:center; padding:12px 0 }
.brand{ font-size:20px; font-weight:800; text-indent:.4em; position:relative; white-space:nowrap; overflow:hidden; text-overflow:ellipsis }
.brand::before{ content:""; position:absolute; inset:auto auto -6px 0; width:72px; height:4px; background:linear-gradient(90deg,#34d399,transparent); border-radius:4px }
.head-right{ margin-left:auto; display:flex; align-items:center; gap:10px }
.badge{ padding:2px 8px; background:#ecfeff; border:1px solid #cffafe; color:#155e75; border-radius:999px; font-weight:800; font-size:12px }

/* ===== 見出しなど ===== */
h1{ font-size:22px; margin:0; font-weight:900 }
.muted{ color:#6b7280 }
.section{ padding:16px 0 }

/* ===== カテゴリボタン ===== */
.catbar{ display:flex; gap:8px; flex-wrap:wrap; align-items:center }
.catbtn{ padding:8px 12px; border:1px solid var(--border); border-radius:999px; background:#fff; cursor:pointer; font-weight:800; font-size:13px }
.catbtn[aria-current="true"]{ background:#111827; color:#fff; border-color:#111827 }
.min-badge{ display:inline-flex; align-items:center; gap:6px; padding:3px 8px; font-size:12px; font-weight:800; border:1px solid var(--border); border-radius:999px; background:#fff; color:#065f46 }

/* ===== 商品カード（PC2列 / SP1列） ===== */
.grid{ display:grid; grid-template-columns:1fr; gap:12px }
@media (min-width:1024px){
  .grid{ grid-template-columns:repeat(2, 1fr) }
}
.card{ border:1px solid var(--border); border-radius:16px; overflow:hidden; background:#fff }
.mi{ display:grid; grid-template-columns:6fr 4fr; gap:0 }
@media (max-width:768px){ .mi{ grid-template-columns:1fr } }

.media{ position:relative; padding:12px; display:flex; flex-direction:column; gap:8px; background:#fff }
.media .dots{ position:absolute; bottom:10px; left:0; right:0; display:flex; gap:6px; justify-content:center }
.media .dot{ width:8px; height:8px; border:1px solid #9ca3af; border-radius:999px; background:#fff }
.info{ display:flex; flex-direction:column; gap:10px; padding:12px; border-left:1px solid var(--border); background:#fff }
@media (max-width:768px){ .info{ border-left:none; border-top:1px solid var(--border) } }

.breadcrumbs{ display:grid; grid-template-columns:3fr 7fr; gap:8px; align-items:center }
.breadcrumbs .bc{ display:flex; gap:6px; align-items:center; flex-wrap:wrap; overflow:auto hidden }
.breadcrumbs .badgewrap{ display:flex; gap:6px; justify-content:flex-end; flex-wrap:wrap }

.name{ font-size:18px; font-weight:900; line-height:1.25; display:block; overflow:hidden; text-overflow:ellipsis; white-space:nowrap }
.pills{ display:flex; gap:6px; flex-wrap:wrap }
.inline-pill{ display:inline-flex; align-items:center; gap:6px; padding:3px 8px; font-size:12px; font-weight:800; border:1px solid var(--border); border-radius:999px; background:#fff; color:#065f46 }

.mi > .media, .mi > .info { min-width:0 }
.img{ aspect-ratio:4/3; border:1px solid var(--border); border-radius:12px; overflow:hidden; background:#fff }
.img>img{ width:100%; height:100%; object-fit:contain; display:block }
.prenote{ background:#f8fafc; border:1px solid #e2e8f0; border-radius:10px; padding:6px 8px; font-size:12px; color:#0369a1 }
.descwrap{ display:grid; grid-template-columns:1fr auto; gap:8px; align-items:end; padding:0 12px 12px }
.desc{ font-size:13px; color:#6b7280; line-height:1.5; min-height:3em; display:-webkit-box; -webkit-line-clamp:3; -webkit-box-orient:vertical; overflow:hidden }
.more{ display:inline-flex; align-items:center; justify-content:center; text-decoration:none; font-weight:800; padding:6px 8px; border:1px dashed var(--border); border-radius:8px; color:#111827; background:#fff }

.pricebar{ display:grid; grid-template-columns:1fr auto; gap:6px; align-items:end }
.price{ font-weight:900; font-size:22px }
.unit{ font-size:12px; color:#6b7280; text-align:right }

.actions{ display:grid; grid-template-columns:7fr 3fr; gap:8px; margin-bottom:10px }
.btn{ appearance:none; border:1px solid var(--border); background:#fff; color:#111827; border-radius:var(--btn-radius); height:var(--btn-h); font-weight:900; cursor:pointer; min-width:0; padding:0 12px; font-size:clamp(13px,1.6vw,16px) }
.btn.add{ background:var(--brand); color:#fff; border-color:transparent }
.btn.add:active{ transform:translateY(1px) }
.vars{ display:flex; flex-direction:column; gap:4px; margin-top:2px }
.pill{ width:100%; padding:6px 8px; border:1px solid var(--border); background:#fff; border-radius:10px; cursor:pointer; font-weight:700; font-size:13px }

/* ===== フッター（カートバー） ===== */
.cart{ position:sticky; bottom:0; left:0; right:0; background:#fff; border-top:1px solid var(--border); z-index:var(--z-sticky) }
.cart .wrap{ padding:0 16px }
.cart-box{
  display:flex; align-items:center; gap:16px;
  justify-content:flex-end;
  padding:10px 0; padding-bottom:calc(10px + env(safe-area-inset-bottom));
}
.cart-left{ margin-right:auto; display:flex; align-items:center; gap:8px }
.lbl-min{ display:none }
@media (min-width:768px){ .lbl-min{ display:block; color:#065f46; font-size:12px; font-weight:800 } }
.count{ font-weight:800 }
.val-date{ font-weight:800 }
.total{ font-weight:900; font-size:18px }
.btn-cart{ background:#111827; color:#fff; border:none; border-radius:12px; padding:10px 14px; font-weight:900; cursor:pointer }

/* ===== ドロワー（カテゴリ） ===== */
.ppp-drawer{ position:fixed; inset:0; z-index:60; display:none }
.ppp-drawer[aria-hidden="false"]{ display:block }
.ppp-drawer__scrim{ position:absolute; inset:0; background:rgba(0,0,0,.35) }
.ppp-drawer__panel{ position:absolute; right:0; top:0; bottom:0; width:min(520px, 100%); background:#fff; border-left:1px solid var(--border); display:flex; flex-direction:column }
.ppp-drawer__bar{ display:flex; align-items:center; justify-content:space-between; padding:10px 12px; border-bottom:1px solid var(--border) }
.ppp-drawer__title{ font-weight:900 }
.ppp-iconbtn{ border:1px solid var(--border); background:#fff; border-radius:10px; padding:6px 10px; cursor:pointer }
.ppp-drawer__search{ padding:10px 12px; border-bottom:1px dashed var(--border); display:flex; gap:8px }
.ppp-drawer__search input{ flex:1; border:1px solid var(--border); border-radius:10px; padding:8px 10px }
.ppp-drawer__body{ flex:1; overflow:auto; padding:12px }
.ppp-list{ display:flex; flex-direction:column; gap:8px }
.ppp-item{ border:1px solid var(--border); border-radius:10px; padding:8px 10px; cursor:pointer; font-weight:800 }

/* ===== カートドロワー ===== */
.ppp-cartdrawer{ position:fixed; inset:0; display:none; z-index:70; }
.ppp-cartdrawer[aria-hidden="false"]{ display:block; }
.ppp-cartdrawer__scrim{ position:absolute; inset:0; background:rgba(0,0,0,.35); }
.ppp-cartdrawer__panel{
  position:absolute; right:0; top:0; bottom:0; width:min(520px, 100%);
  background:#fff; border-left:1px solid var(--border); display:flex; flex-direction:column;
}
.ppp-cartdrawer__header{ display:flex; align-items:center; justify-content:space-between; padding:14px 16px; border-bottom:1px solid var(--border); }
.ppp-cartdrawer__close{ background:#f1f5f9; border:1px solid #e2e8f0; border-radius:8px; padding:6px 10px; cursor:pointer; }
.ppp-cartdrawer__body{ flex:1; overflow:auto; padding:12px 12px 0; }
.ppp-cartdrawer__empty{ padding:16px; }
.ppp-cartdrawer__list{ display:flex; flex-direction:column; gap:10px; padding-bottom:12px; }
.ppp-cartrow{ border:1px solid var(--border); border-radius:12px; padding:10px 12px; }
.ppp-cartrow__top{ display:flex; gap:10px; align-items:center; }
.ppp-cartrow__img{ width:64px; height:64px; border-radius:10px; overflow:hidden; background:#f8fafc; border:1px solid #f1f5f9; flex:none }
.ppp-cartrow__img img{ width:100%; height:100%; object-fit:cover }
.ppp-cartrow__meta{ flex:1; min-width:0 }
.ppp-cartrow__name{ font-weight:800; font-size:14px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis }
.ppp-cartrow__unit{ color:var(--muted); font-size:12px }
.ppp-cartrow__price{ font-weight:900; }
.ppp-cartrow__qty{ display:flex; align-items:center; gap:6px; margin-top:8px }
.ppp-cartrow__qty input{ width:56px; text-align:center; padding:6px 8px; border:1px solid var(--border); border-radius:8px }
.ppp-cartrow__actions{ margin-left:auto; display:flex; gap:6px }
.ppp-cartdrawer__footer{
  border-top:1px solid var(--border); padding:12px; display:grid; grid-template-columns:1fr 1fr; gap:12px; align-items:center;
}
.ppp-cartdrawer__meta .lbl{ font-size:12px; color:var(--brand-ink) }
.ppp-cartdrawer__meta .val{ font-weight:800 }
.ppp-cartdrawer__total .lbl{ font-size:12px; color:#64748b; text-align:right }
.ppp-cartdrawer__total .val{ font-size:18px; font-weight:900; text-align:right }
.ppp-cartdrawer__pickup{ grid-column:1 / -1; display:flex; gap:8px; align-items:center }
.ppp-cartdrawer__pickup .lbl{ font-size:12px; color:#111827; min-width:5.5em }
.ppp-select{ border:1px solid var(--border); border-radius:12px; padding:10px 12px; font-weight:800; flex:1 }
.ppp-cartdrawer__actions{ grid-column:1 / -1; display:flex; gap:8px; justify-content:flex-end }
.btn.outline{ background:#fff; border:1px solid var(--border); border-radius:12px; padding:10px 14px; font-weight:800; cursor:pointer }
.btn.primary{ background:var(--brand); color:#fff; border:none; border-radius:12px; padding:10px 16px; font-weight:900; cursor:pointer }
.btn.primary:disabled{ opacity:.5; cursor:not-allowed }
.note-warn{ color:#b45309; font-size:12px }
</style>
</head>
<body>

<header>
  <div class="wrap header-in">
    <div class="brand">Ping-Pong-Pang</div>
    <div class="head-right">
      <span class="badge">翌日以降受取予約</span>
    </div>
  </div>
</header>

<main class="wrap">
  <section class="section">
    <h1 style="margin:.2em 0 0">翌日以降受取予約注文</h1>
    <p class="muted" style="font-size:14px; margin:.3em 0 8px">
      受け取り予約ページです。商品はイメージ／価格は税込。入荷状況により数量調整のご相談をすることがあります。
    </p>
  </section>

  <section class="section">
    <div class="catbar">
      <button class="catbtn" id="openCat">カテゴリ</button>
      <span class="min-badge" id="minDateBadge">最短受取 —</span>
    </div>
  </section>

  <section class="section">
    <div id="grid" class="grid">
      <!-- JSで商品カードを差し込み -->
    </div>
  </section>

  <section class="section">
    <p class="muted" style="font-size:12px">
      画像はイメージ／価格は税込／在庫状況により数量調整のご相談をすることがあります。
    </p>
  </section>
</main>

<!-- ===== フッター ===== -->
<div class="cart" id="cartBar">
  <div class="wrap">
    <div class="cart-box">
      <div class="cart-left"><span class="inline-pill" id="cartMinPill">最短受取 —</span></div>
      <div class="lbl-min">最短受取日</div>
      <div class="count" id="cartCount">0点</div>
      <div class="val-date" id="cartMinDate">—</div>
      <div class="total" id="cartTotal">¥0</div>
      <button class="btn-cart" id="checkoutBtn2">カート</button>
    </div>
  </div>
</div>

<!-- ===== カートドロワー ===== -->
<div id="cartDrawer" class="ppp-cartdrawer" aria-hidden="true">
  <div class="ppp-cartdrawer__scrim" data-cart="close"></div>
  <aside class="ppp-cartdrawer__panel" role="dialog" aria-modal="true" aria-labelledby="cartDrawerTitle">
    <header class="ppp-cartdrawer__header">
      <h2 id="cartDrawerTitle">カート</h2>
      <button class="ppp-cartdrawer__close" data-cart="close" aria-label="閉じる">×</button>
    </header>

    <div class="ppp-cartdrawer__body">
      <div id="cartEmpty" class="ppp-cartdrawer__empty muted" style="display:none">カートは空です</div>
      <div id="cartList" class="ppp-cartdrawer__list"></div>
    </div>

    <footer class="ppp-cartdrawer__footer">
      <div class="ppp-cartdrawer__meta">
        <div class="lbl">最短受取日</div>
        <div class="val" id="cartMinDateDrawer">—</div>
      </div>
      <div class="ppp-cartdrawer__total">
        <div class="lbl">合計</div>
        <div class="val" id="cartTotalDrawer">¥0</div>
      </div>

      <div class="ppp-cartdrawer__pickup">
        <div class="lbl">受け取り日</div>
        <select id="pickupDateSelect" class="ppp-select"></select>
      </div>
      <div class="note-warn" id="pickupNote" style="display:none">※ 選択した日付は最短受取より前です。変更してください。</div>

      <div class="ppp-cartdrawer__actions">
        <button class="btn outline" data-cart="close">買い物を続ける</button>
        <button class="btn primary" id="checkoutBtnGo" disabled>フォームへ進む</button>
      </div>
    </footer>
  </aside>
</div>

<!-- ===== カテゴリ選択ドロワー（器のみ） ===== -->
<div id="catDrawer" class="ppp-drawer" aria-hidden="true" role="dialog" aria-modal="true">
  <div class="ppp-drawer__scrim"></div>
  <section class="ppp-drawer__panel" role="document" aria-labelledby="catDrawerTitle">
    <div class="ppp-drawer__bar">
      <button class="ppp-iconbtn" id="catDrawerBack" title="戻る" aria-label="戻る" style="visibility:hidden">←</button>
      <div class="ppp-drawer__title" id="catDrawerTitle">カテゴリを選ぶ</div>
      <button class="ppp-iconbtn" id="catDrawerClose" title="閉じる" aria-label="閉じる">✕</button>
    </div>
    <div class="ppp-drawer__search">
      <input id="catDrawerQuery" placeholder="カテゴリ名や商品名で検索" />
      <button class="ppp-iconbtn" id="catDrawerClear">クリア</button>
    </div>
    <div class="ppp-drawer__body">
      <div id="catList" class="ppp-list"></div>
    </div>
  </section>
</div>

<script>
/* ====== 設定 ====== */
const PRODUCTS_URL = 'https://script.google.com/macros/s/AKfycbzaMJ8p9_Fj9pr7dgFBzl0cApTQn0llr6-I1b9YhyKPGwbD461NBA6_U6WEzPqOpf4b/exec?endpoint=products';
const TAXONOMY_URL = 'https://script.google.com/macros/s/AKfycbzaMJ8p9_Fj9pr7dgFBzl0cApTQn0llr6-I1b9YhyKPGwbD461NBA6_U6WEzPqOpf4b/exec?endpoint=taxonomy';
const CUTOVER_HOUR = 2; // 26:00 = 翌日2:00

// Googleフォーム（本番）
const FORM_BASE = 'https://docs.google.com/forms/d/1YIAy0CpQ-r0DrqsG6kvpn95FVFu700EMAM-nnvkrX4c/viewform';
const ENTRY = {
  ORDER_LIST:       'entry.1286573866', // 注文商品一覧（可読）
  NAME:             'entry.1872572951',
  TEL:              'entry.823790722',
  PICKUP_DATE:      'entry.1515941336', // YYYY-MM-DD（ユーザー選択をセット）
  // MIN_POSSIBLE_TXT:'entry.1229502757', // ← 表示用はプリフィル停止
  PICKUP_TIME:      'entry.145233294',
  NOTE:             'entry.907378750',
  MIN_POSSIBLE_SYS: 'entry.224243122', // システム最短（編集禁止）YYYY-MM-DD
  ORDER_JSON:       'entry.1040973575'  // 取り込み用JSON
};

const state = {
  products: [],
  cart: JSON.parse(localStorage.getItem('cart')||'{}'),
  selectedPickupISO: null,
  taxonomy: null,
  closedSet: null
};
const productById = new Map();

/* ====== ユーティリティ ====== */
const yen = n => '¥' + (Number(n||0)).toLocaleString('ja-JP');
const escapeHtml = s => String(s||'').replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m]));
const isoDate = d => [d.getFullYear(), String(d.getMonth()+1).padStart(2,'0'), String(d.getDate()).padStart(2,'0')].join('-');
const fmtJP  = d => `${d.getFullYear()}/${String(d.getMonth()+1).padStart(2,'0')}/${String(d.getDate()).padStart(2,'0')}`;
const wdJP = d => '日月火水木金土'[d.getDay()];

/* ====== 26:00締切を反映した最短基準 ====== */
function calcMinDateBase(){
  const now = new Date();
  const base = new Date(now);
  if(now.getHours() >= CUTOVER_HOUR){ // 2時以降は+1日
    base.setDate(base.getDate()+1);
  }
  base.setHours(0,0,0,0);
  return base;
}

/* ====== カート ====== */
function totals(){
  let total=0, count=0;
  for(const id of Object.keys(state.cart)){
    const q = Number(state.cart[id]||0);
    if(q<=0) continue;
    const p = productById.get(id) || {};
    total += (Number(p.price||0) * q);
    count += q;
  }
  return { total, count };
}
function getCartItems(){
  const items=[];
  for(const id of Object.keys(state.cart||{})){
    const q = Number(state.cart[id]||0);
    if(q<=0) continue;
    const p = productById.get(id) || {};
    items.push({
      id, name: p.name||'', price: Number(p.price||0), qty:q,
      subtotal: Number(p.price||0)*q,
      unitNote: p.unitNote||'',
      leadDays: Number(p.leadDays||1),
      img: (p.img||'').trim()
    });
  }
  return items;
}
function calcMinDateForCart(){
  const base = calcMinDateBase();
  const items = getCartItems();
  const maxLead = items.reduce((m, it)=> Math.max(m, Number(it.leadDays||1)), 0);
  const d = new Date(base);
  d.setDate(d.getDate() + maxLead);
  d.setHours(0,0,0,0);
  return d;
}
function renderCartBar(){
  const t = totals();
  const elCount = document.getElementById('cartCount');
  const elTotal = document.getElementById('cartTotal');
  const elMin   = document.getElementById('cartMinDate');
  const pill    = document.getElementById('cartMinPill');
  const minBadge= document.getElementById('minDateBadge');

  if(elCount) elCount.textContent = `${t.count}点`;
  if(elTotal) elTotal.textContent = yen(t.total);

  // フッターの最短は leadDays を含む
  const min = calcMinDateForCart();
  const jp = fmtJP(min);
  if(elMin) elMin.textContent = jp;
  if(pill) pill.textContent   = `最短受取 ${jp}`;
  if(minBadge) minBadge.textContent = `最短受取 ${jp}`;
}

/* ====== 商品描画 ====== */
function cardTpl(p){
  return `
  <article class="card" data-id="${p.id}">
    <div class="mi">
      <div class="media">
        <div class="img"><img src="${p.img||''}" alt=""></div>
        <div class="dots"><span class="dot"></span><span class="dot"></span><span class="dot"></span></div>
      </div>
      <div class="info">
        <div class="breadcrumbs">
          <div class="bc"><span class="inline-pill">${p.cat||'未分類'}</span></div>
          <div class="badgewrap">
            ${(p.badges||[]).slice(0,3).map(b=>`<span class="badge">${escapeHtml(b)}</span>`).join('')}
          </div>
        </div>
        <div class="name">${escapeHtml(p.name||'')}</div>
        ${p.prenote?`<div class="prenote">${escapeHtml(p.prenote)}</div>`:''}
        <div class="pricebar">
          <div class="price">${p.price>0?yen(p.price):'店頭価格'}</div>
          <div class="unit">${escapeHtml(p.unitNote||'')}</div>
        </div>
        <div class="actions">
          <button class="btn add" data-cart="add">カート追加</button>
          <button class="btn" data-later="1">あとで</button>
        </div>
        <div class="vars">
          ${(p.variants||[]).slice(0,2).map(v=>`<button class="pill" data-variant="${escapeHtml(v.id)}">${escapeHtml(v.name)}</button>`).join('')}
        </div>
        <div class="descwrap">
          <div class="desc">${escapeHtml(p.desc||'')}</div>
          <a class="more" href="#" data-open="drawer">もっと見る</a>
        </div>
      </div>
    </div>
  </article>`;
}
function renderProducts(list){
  const wrap = document.getElementById('grid');
  wrap.innerHTML = list.map(cardTpl).join('');
}

/* ====== データロード ====== */
async function loadProducts(){
  const res = await fetch(PRODUCTS_URL, { cache:'no-cache' });
  const json = await res.json();
  const list = json.products || json || [];
  state.products = list;
  productById.clear();
  list.forEach(p=> productById.set(p.id, p));
  renderProducts(list);
  renderCartBar();
}
async function loadTaxonomy(){
  try{
    const res = await fetch(TAXONOMY_URL, { cache:'no-cache' });
    const json = await res.json();
    state.taxonomy = json;
    const closed = (json.closed || json.holidays || [])
      .concat(Array.isArray(window.PPP_CLOSED_DATES)? window.PPP_CLOSED_DATES : [])
      .map(s => String(s).slice(0,10));
    state.closedSet = new Set(closed);
  }catch(e){
    const closed = (Array.isArray(window.PPP_CLOSED_DATES)? window.PPP_CLOSED_DATES : []).map(s=>String(s).slice(0,10));
    state.closedSet = new Set(closed);
  }
}

/* ====== 受取日セレクタ ====== */
function computeSelectableDates(){
  const min = calcMinDateForCart();
  const out = [];
  for(let i=0;i<=7;i++){
    const d = new Date(min); d.setDate(min.getDate()+i);
    const iso = isoDate(d);
    if(state.closedSet && state.closedSet.has(iso)) continue;
    out.push(d);
  }
  return out;
}
function renderPickupDateSelect(){
  const sel = document.getElementById('pickupDateSelect');
  const note = document.getElementById('pickupNote');
  const btn  = document.getElementById('checkoutBtnGo');
  if(!sel) return;

  const dates = computeSelectableDates();
  sel.innerHTML = dates.map(d => `<option value="${isoDate(d)}">${fmtJP(d)}（${wdJP(d)}）</option>`).join('');

  const minISO = dates.length ? isoDate(dates[0]) : null;
  if(!state.selectedPickupISO || !dates.some(d=>isoDate(d)===state.selectedPickupISO)){
    state.selectedPickupISO = minISO;
  }
  sel.value = state.selectedPickupISO || '';

  const minEl = document.getElementById('cartMinDateDrawer');
  if(minEl && dates.length) minEl.textContent = fmtJP(dates[0]);

  const invalid = !state.selectedPickupISO;
  btn.disabled = invalid;
  note.style.display = invalid ? '' : 'none';
}

/* ====== カートドロワー ====== */
function renderCartDrawer(){
  const listEl = document.getElementById('cartList');
  const emptyEl= document.getElementById('cartEmpty');
  const totalEl= document.getElementById('cartTotalDrawer');

  const items = getCartItems();
  const isEmpty = items.length===0;

  if(isEmpty){
    listEl.innerHTML='';
    emptyEl.style.display='';
  }else{
    emptyEl.style.display='none';
    listEl.innerHTML = items.map(it=>{
      const img = it.img ? it.img : 'https://placehold.co/128x128/png?text=No+Image';
      return `
        <div class="ppp-cartrow" data-id="${it.id}">
          <div class="ppp-cartrow__top">
            <div class="ppp-cartrow__img"><img src="${img}" alt=""></div>
            <div class="ppp-cartrow__meta">
              <div class="ppp-cartrow__name">${escapeHtml(it.name)}</div>
              ${it.unitNote?`<div class="ppp-cartrow__unit">${escapeHtml(it.unitNote)}</div>`:''}
              <div class="ppp-cartrow__price">${(it.price>0)?yen(it.price):'店頭価格'}</div>
              <div class="ppp-cartrow__qty">
                <button class="btn outline" data-cart="dec" aria-label="数量を減らす">−</button>
                <input class="cartqty" type="number" min="0" step="1" value="${it.qty}">
                <button class="btn outline" data-cart="inc" aria-label="数量を増やす">＋</button>
                <div class="ppp-cartrow__actions">
                  <button class="btn outline" data-cart="remove">削除</button>
                </div>
              </div>
            </div>
          </div>
        </div>`;
    }).join('');
  }

  if(totalEl) totalEl.textContent = yen(items.reduce((s,it)=>s+it.subtotal,0));
  renderPickupDateSelect();
}
function openCartDrawer(){
  renderCartDrawer();
  const root = document.getElementById('cartDrawer');
  if(root) root.setAttribute('aria-hidden', 'false');
}
function closeCartDrawer(){
  const root = document.getElementById('cartDrawer');
  if(root) root.setAttribute('aria-hidden', 'true');
}

/* ====== プレフィルURL生成 ====== */
function buildOrderListText(items){
  return items.map(it=>{
    const unit = it.price>0 ? `（単価 ${yen(it.price)}）` : '';
    const subtotal = it.price>0 ? `＝ ${yen(it.subtotal)}` : '';
    return `・${it.name} × ${it.qty} ${unit} ${subtotal}`.trim();
  }).join('\n');
}
function buildPrefillUrl(){
  const items = getCartItems();
  const payload = items.map(it=>({ id:it.id, name:it.name, price:it.price, qty:it.qty, subtotal:it.subtotal, leadDays:it.leadDays }));
  const minDate = calcMinDateForCart();
  const pickISO = state.selectedPickupISO || isoDate(minDate);

  const params = new URLSearchParams();
  params.set(ENTRY.ORDER_LIST, buildOrderListText(items));
  params.set(ENTRY.ORDER_JSON, JSON.stringify(payload));
  params.set(ENTRY.PICKUP_DATE, pickISO);             // ユーザー選択
  params.set(ENTRY.MIN_POSSIBLE_SYS, isoDate(minDate)); // バックエンド検証用

  return `${FORM_BASE}?${params.toString()}`;
}

/* ====== イベント ====== */
document.addEventListener('click', function(ev){
  // カード：カートに追加
  const add = ev.target.closest('[data-cart="add"]');
  if(add){
    const card = ev.target.closest('.card');
    const id = card?.dataset.id;
    if(id){
      const cur = Number(state.cart[id]||0);
      state.cart[id] = cur + 1;
      try{ localStorage.setItem('cart', JSON.stringify(state.cart)); }catch(_){}
      renderCartBar();
    }
  }

  // カートを開く
  if(ev.target.closest('#checkoutBtn2')){
    ev.preventDefault();
    openCartDrawer();
  }

  // ドロワー：閉じる
  if(ev.target.closest('[data-cart="close"]')){
    ev.preventDefault();
    closeCartDrawer();
  }

  // ドロワー：数量操作/削除
  const row = ev.target.closest('.ppp-cartrow');
  if(row){
    const id = row.dataset.id;
    if(ev.target.closest('[data-cart="inc"]')){ ev.preventDefault(); setQty(id, (Number(state.cart[id]||0))+1); }
    if(ev.target.closest('[data-cart="dec"]')){ ev.preventDefault(); setQty(id, (Number(state.cart[id]||0))-1); }
    if(ev.target.closest('[data-cart="remove"]')){ ev.preventDefault(); setQty(id, 0); }
  }

  // フォームへ進む
  if(ev.target.closest('#checkoutBtnGo')){
    ev.preventDefault();
    const items = getCartItems();
    if(items.length===0){ alert('カートが空です'); return; }
    if(!state.selectedPickupISO){ alert('受け取り日を選択してください'); return; }
    window.location.href = buildPrefillUrl();
  }
});
document.addEventListener('input', function(ev){
  const inp = ev.target.closest('.ppp-cartrow input.cartqty');
  if(inp){
    const row = ev.target.closest('.ppp-cartrow');
    const id  = row?.dataset.id;
    const v   = Math.max(0, Math.floor(Number(inp.value||0)));
    setQty(id, v);
  }
});
document.addEventListener('change', function(ev){
  const sel = ev.target.closest('#pickupDateSelect');
  if(sel){
    state.selectedPickupISO = sel.value || null;
    const minISO = isoDate(calcMinDateForCart());
    const note = document.getElementById('pickupNote');
    const btn  = document.getElementById('checkoutBtnGo');
    const invalid = !state.selectedPickupISO || state.selectedPickupISO < minISO;
    note.style.display = invalid ? '' : 'none';
    btn.disabled = invalid;
  }
});

/* ====== 共通 ====== */
function setQty(id, v){
  if(!id) return;
  if(v<=0){ delete state.cart[id]; } else { state.cart[id] = v; }
  try{ localStorage.setItem('cart', JSON.stringify(state.cart)); }catch(_){}
  renderCartBar();
  renderCartDrawer();
}

/* ====== 起動 ====== */
(async function init(){
  await Promise.all([loadProducts(), loadTaxonomy()]);
  renderCartBar();
})();
</script>
</body>
</html>
