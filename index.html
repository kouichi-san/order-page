<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
  <title>Ping-Pong-Pang 受注ページ</title>
  <meta name="color-scheme" content="light dark">

  <!-- ===== Base (最小限のリセット) ===== -->
  <style>
    *,*::before,*::after{box-sizing:border-box}
    html,body{margin:0;padding:0}
    body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Inter,'Helvetica Neue','Hiragino Kaku Gothic ProN','Noto Sans JP',Meiryo,system-ui,sans-serif;line-height:1.6;color:#111;background:#fff}
    img{max-width:100%;display:block}
    button{cursor:pointer}
    .wrap{max-width:1080px;margin:0 auto;padding:12px}
    .hidden{display:none!important}
    .muted{color:#6b7280}
    /* ドロワー表示中のページスクロール抑止 */
    html.ppp-no-scroll, body.ppp-no-scroll{overflow:hidden!important;touch-action:none!important}
  </style>

  <!-- ===== Drawer Styles（黒被り/スクロール/右→中央仕様） ===== -->
  <style>
    /* コンテナ */
    .ppp-drawer{position:fixed;inset:0;z-index:4000;display:none}
    .ppp-drawer[aria-hidden="false"]{display:block}

    /* 暗幕：前面に被り過ぎない＆パネルの下 */
    .ppp-drawer__scrim{
      position:absolute;inset:0;background:rgba(0,0,0,.18);
      opacity:0;transition:opacity .18s ease;z-index:0;
    }
    .ppp-drawer[aria-hidden="false"] .ppp-drawer__scrim{opacity:1}

    /* パネル：右からスライドイン */
    .ppp-drawer__panel{
      position:absolute;top:0;right:0;height:100%;
      width:min(960px,92vw);background:#fff;color:inherit;
      box-shadow:-10px 0 24px rgba(0,0,0,.16);
      transform:translateX(100%);transition:transform .24s ease;
      display:grid;grid-template-rows:auto auto auto 1fr auto; /* header, search, chips, list(scroll), footer */
      overflow:hidden;padding-bottom:env(safe-area-inset-bottom);
      z-index:1;
    }
    .ppp-drawer[aria-hidden="false"] .ppp-drawer__panel{transform:translateX(0)}

    /* ヘッダーバー */
    .ppp-drawer__bar{
      display:flex;align-items:center;gap:8px;
      padding:12px 14px;border-bottom:1px solid #e5e7eb;
    }
    .ppp-drawer__title{font-weight:700;font-size:16px;flex:1}
    .ppp-iconbtn{appearance:none;border:1px solid #e5e7eb;background:#fff;border-radius:10px;padding:8px 10px}
    .ppp-iconbtn:active{transform:translateY(1px)}

    /* 検索行 */
    .ppp-drawer__search{padding:10px 14px;border-bottom:1px solid #f1f5f9}
    .ppp-input{width:100%;font-size:16px;padding:10px 12px;border-radius:10px;border:1px solid #e5e7eb;background:#fff}

    /* 選択済みチップ領域 */
    .ppp-chips{display:flex;gap:8px;flex-wrap:wrap;align-items:center;padding:8px 14px;border-bottom:1px dashed #eef2f7}
    .ppp-chip{display:inline-flex;align-items:center;gap:6px;background:#f3f4f6;border:1px solid #e5e7eb;border-radius:999px;padding:6px 10px;font-size:12px}
    .ppp-chip .x{border:none;background:transparent;font-size:14px;line-height:1}

    /* スクロール領域（カテゴリ/サブカテゴリ） */
    .ppp-listwrap{overflow:auto;-webkit-overflow-scrolling:touch}
    .ppp-listpad{padding:10px 12px 16px}

    /* グリッド */
    .ppp-catgrid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:8px}
    @media (min-width:720px){ .ppp-catgrid{grid-template-columns:repeat(3,minmax(0,1fr))} }
    @media (min-width:960px){ .ppp-catgrid{grid-template-columns:repeat(4,minmax(0,1fr))} }

    .ppp-catbtn{
      display:flex;align-items:center;justify-content:space-between;gap:8px;
      border:1px solid #e5e7eb;background:#fff;border-radius:12px;padding:10px 12px;
      text-align:left;font-size:14px
    }
    .ppp-catbtn .name{flex:1;min-width:0;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .ppp-catbtn .badge{display:none} /* 0/0 バッジ非表示 */
    .ppp-catbtn:active{transform:translateY(1px)}

    /* フッター操作 */
    .ppp-drawer__footer{display:flex;gap:10px;padding:10px 14px;border-top:1px solid #e5e7eb;background:#fafafa}
    .ppp-btn{flex:1;appearance:none;border:1px solid #e5e7eb;background:#fff;border-radius:12px;padding:12px 14px;font-weight:600}
    .ppp-btn.primary{background:#1e40af;color:#fff;border-color:#1e40af}
    .ppp-btn.warn{background:#fee2e2;border-color:#fecaca}
  </style>
</head>
<body>
  <header class="wrap" style="display:flex;align-items:center;gap:10px">
    <h1 style="margin:.2em 0 0;font-size:18px;flex:1">翌日以降受取予約注文</h1>
    <!-- カテゴリボタン（IDは既存運用に合わせて） -->
    <button id="btnCategories" class="ppp-iconbtn" aria-haspopup="dialog" aria-controls="catDrawer">カテゴリ</button>
  </header>

  <main class="wrap">
    <!-- ここに商品カードが描画される想定（既存のあなたのJSが担当） -->
    <div id="productList" class="section"></div>
  </main>

  <footer class="wrap" style="padding:16px 12px;border-top:1px solid #e5e7eb;margin-top:24px">
    <div class="muted">最短受取やカートUIなど既存の実装をここに</div>
  </footer>

  <!-- ===== Category Drawer ===== -->
  <div id="catDrawer" class="ppp-drawer" aria-hidden="true" role="dialog" aria-modal="true">
    <div class="ppp-drawer__scrim"></div>
    <section class="ppp-drawer__panel" role="document" aria-labelledby="catDrawerTitle">
      <!-- bar -->
      <div class="ppp-drawer__bar">
        <button class="ppp-iconbtn" id="catBackBtn" title="戻る" aria-label="戻る">←</button>
        <div class="ppp-drawer__title" id="catDrawerTitle">カテゴリを選ぶ</div>
        <button class="ppp-iconbtn" id="catCloseBtn" title="閉じる" aria-label="閉じる">✕</button>
      </div>
      <!-- search -->
      <div class="ppp-drawer__search">
        <input id="catQuery" class="ppp-input" type="search" placeholder="カテゴリ名・サブカテゴリ名で絞り込み">
      </div>
      <!-- chips -->
      <div class="ppp-chips" id="catChips" aria-live="polite"></div>
      <!-- list (scroll area) -->
      <div class="ppp-listwrap">
        <div class="ppp-listpad">
          <div id="catGrid" class="ppp-catgrid" role="list"></div>
        </div>
      </div>
      <!-- footer -->
      <div class="ppp-drawer__footer">
        <button id="catClearBtn" class="ppp-btn warn">クリア</button>
        <button id="catApplyBtn" class="ppp-btn primary">この条件で絞り込む</button>
      </div>
    </section>
  </div>

  <!-- ===== App Script（カテゴリドロワーは独立モジュール / 最小干渉） ===== -->
  <script>
  (function(){
    "use strict";

    /* =========== 設定（GASのURLを差し替え） ===========================
       - PRODUCTS_URL: 商品一覧エンドポイント（既存のあなたの実装で利用）
       - TAXONOMY_URL: カテゴリ・サブカテゴリ一覧（本ドロワーが利用）
       例）
       https://script.google.com/macros/s/AKfycb.../exec?endpoint=taxonomy
    =================================================================== */
    const PRODUCTS_URL = 'https://script.google.com/macros/s/AKfycbzaMJ8p9_Fj9pr7dgFBzl0cApTQn0llr6-I1b9YhyKPGwbD461NBA6_U6WEzPqOpf4b/exec?endpoint=products';
    const TAXONOMY_URL = 'https://script.google.com/macros/s/AKfycbzaMJ8p9_Fj9pr7dgFBzl0cApTQn0llr6-I1b9YhyKPGwbD461NBA6_U6WEzPqOpf4b/exec?endpoint=taxonomy';

    /* =========== DOM取得（頻出はキャッシュ） ======================== */
    const qs  = (s,el=document)=>el.querySelector(s);
    const qsa = (s,el=document)=>[...el.querySelectorAll(s)];

    const drawer  = qs('#catDrawer');
    const scrim   = qs('.ppp-drawer__scrim', drawer);
    const panel   = qs('.ppp-drawer__panel', drawer);
    const backBtn = qs('#catBackBtn', drawer);
    const closeBtn= qs('#catCloseBtn', drawer);
    const queryI  = qs('#catQuery', drawer);
    const chips   = qs('#catChips', drawer);
    const grid    = qs('#catGrid', drawer);
    const clearBtn= qs('#catClearBtn', drawer);
    const applyBtn= qs('#catApplyBtn', drawer);
    const openBtn = qs('#btnCategories');

    /* =========== 状態 =============================================== */
    const State = {
      taxonomy: null,              // { categories: [{name, id, subcategories:[{name,id}]}], ... }
      phase: 'category',           // 'category' | 'subcategory'
      selectedCategory: null,      // {id, name} or null
      selectedSubcategory: null,   // {id, name} or null
      query: '',
    };

    /* =========== 公開イベント（呼び出し側が受け取る） =================
       - 'ppp:categoryChange' detail: { category, subcategory }
       既存のロード関数を触らず、このイベントに反応して絞り込み処理を実装してください。
    =================================================================== */
    function dispatchSelection(){
      const detail = {
        category: State.selectedCategory,
        subcategory: State.selectedSubcategory
      };
      window.dispatchEvent(new CustomEvent('ppp:categoryChange', { detail }));
    }

    /* =========== ネットワーク ======================================= */
    async function fetchTaxonomy(){
      if (State.taxonomy) return State.taxonomy;
      const url = TAXONOMY_URL;
      const res = await fetch(url, { cache:'no-store' });
      if(!res.ok) throw new Error('taxonomy fetch failed');
      const data = await res.json(); // 期待: { categories: [ {id,name,subcategories:[{id,name}]} ] }
      // 互換: GASが {taxonomy:[...]} などでも拾う
      State.taxonomy = data.categories || data.taxonomy || data;
      return State.taxonomy;
    }

    /* =========== レンダリング ======================================= */
    function renderChips(){
      const fr = document.createDocumentFragment();
      chips.innerHTML = '';
      if(State.selectedCategory){
        const chip = document.createElement('span');
        chip.className = 'ppp-chip';
        chip.innerHTML = `<span>カテゴリ: ${escapeHtml(State.selectedCategory.name)}</span><button class="x" aria-label="カテゴリ解除">×</button>`;
        chip.querySelector('.x').addEventListener('click', ()=>{
          State.selectedCategory = null;
          State.selectedSubcategory = null;
          State.phase = 'category';
          render();
        });
        fr.appendChild(chip);
      }
      if(State.selectedSubcategory){
        const chip = document.createElement('span');
        chip.className = 'ppp-chip';
        chip.innerHTML = `<span>サブ: ${escapeHtml(State.selectedSubcategory.name)}</span><button class="x" aria-label="サブカテゴリ解除">×</button>`;
        chip.querySelector('.x').addEventListener('click', ()=>{
          State.selectedSubcategory = null;
          State.phase = State.selectedCategory ? 'subcategory' : 'category';
          render();
        });
        fr.appendChild(chip);
      }
      chips.appendChild(fr);
    }

    function renderCategoryGrid(){
      const items = (State.taxonomy || []);
      const q = State.query.trim().toLowerCase();
      const filtered = q ? items.filter(it => (it.name||'').toLowerCase().includes(q)) : items;

      grid.innerHTML = '';
      const fr = document.createDocumentFragment();
      filtered.forEach(cat=>{
        const btn = document.createElement('button');
        btn.type='button';
        btn.className='ppp-catbtn';
        btn.setAttribute('role','listitem');
        btn.innerHTML = `<span class="name">${escapeHtml(cat.name||'（名称未設定）')}</span><span class="badge"></span>`;
        btn.addEventListener('click', ()=>{
          onSelectCategory(cat);
        });
        fr.appendChild(btn);
      });
      grid.appendChild(fr);
    }

    function renderSubcategoryGrid(){
      const cat = State.selectedCategory;
      const subs = (cat && (cat.subcategories || cat.children || [])) || [];
      const q = State.query.trim().toLowerCase();
      const filtered = q ? subs.filter(s => (s.name||'').toLowerCase().includes(q)) : subs;

      grid.innerHTML = '';
      const fr = document.createDocumentFragment();

      // 「サブなしでカテゴリだけ適用」ショートカット
      const btnCatOnly = document.createElement('button');
      btnCatOnly.type='button';
      btnCatOnly.className='ppp-catbtn';
      btnCatOnly.innerHTML = `<span class="name">（サブカテゴリなしで適用）</span>`;
      btnCatOnly.addEventListener('click', ()=>{
        State.selectedSubcategory = null;
        applyAndClose();
      });
      fr.appendChild(btnCatOnly);

      filtered.forEach(sub=>{
        const btn = document.createElement('button');
        btn.type='button';
        btn.className='ppp-catbtn';
        btn.setAttribute('role','listitem');
        btn.innerHTML = `<span class="name">${escapeHtml(sub.name||'（名称未設定）')}</span><span class="badge"></span>`;
        btn.addEventListener('click', ()=>{
          State.selectedSubcategory = { id: sub.id ?? sub.code ?? sub.value ?? String(sub.name), name: sub.name ?? String(sub.id ?? '') };
          applyAndClose();
        });
        fr.appendChild(btn);
      });
      grid.appendChild(fr);
    }

    function render(){
      renderChips();
      if(State.phase === 'category'){
        qs('#catBackBtn').classList.add('hidden');
        qs('#catDrawerTitle').textContent = 'カテゴリを選ぶ';
        renderCategoryGrid();
      }else{
        qs('#catBackBtn').classList.remove('hidden');
        qs('#catDrawerTitle').textContent = 'サブカテゴリを選ぶ';
        renderSubcategoryGrid();
      }
    }

    /* =========== 選択ロジック ======================================= */
    function onSelectCategory(cat){
      State.selectedCategory = {
        id: cat.id ?? cat.code ?? cat.value ?? String(cat.name),
        name: cat.name ?? String(cat.id ?? '')
      };
      const subs = cat.subcategories || cat.children || [];
      if(subs && subs.length){
        State.phase = 'subcategory';
        State.selectedSubcategory = null;
        render();
      }else{
        // サブカテゴリが無い → そのまま適用
        State.selectedSubcategory = null;
        applyAndClose();
      }
    }

    function applyAndClose(){
      dispatchSelection();
      closeDrawer();
    }

    function clearSelection(){
      State.selectedCategory = null;
      State.selectedSubcategory = null;
      State.phase = 'category';
      State.query = '';
      queryI.value = '';
      render();
    }

    /* =========== 開閉制御（スクロールロック/誤タップ回避） =========== */
    function onKeydown(e){
      if(e.key === 'Escape'){ closeDrawer(); }
    }

    async function openCategories(){
      document.documentElement.classList.add('ppp-no-scroll');
      document.body.classList.add('ppp-no-scroll');

      drawer.setAttribute('aria-hidden','false');
      State.phase = State.selectedCategory ? 'subcategory' : 'category';
      await fetchTaxonomy(); // 一度取得したらキャッシュ

      render();
      // 初期フォーカス：preventScrollで背面影響なし
      setTimeout(()=>{ try{ queryI.focus({preventScroll:true}); }catch(_){} }, 30);
      window.addEventListener('keydown', onKeydown);
    }

    function closeDrawer(){
      document.documentElement.classList.remove('ppp-no-scroll');
      document.body.classList.remove('ppp-no-scroll');
      try{ queryI.blur(); }catch(_){}
      drawer.setAttribute('aria-hidden','true');
      window.removeEventListener('keydown', onKeydown);
    }

    /* =========== イベント結線 ======================================= */
    // トリガーボタン
    openBtn?.addEventListener('click', openCategories);

    // 暗幕クリック：純粋に暗幕を押したときのみ閉じる
    scrim.addEventListener('click', (e)=>{
      if(e.target !== scrim) return;
      closeDrawer();
    });

    // 閉じる/戻る
    closeBtn.addEventListener('click', closeDrawer);
    backBtn.addEventListener('click', ()=>{
      if(State.phase === 'subcategory'){
        State.phase = 'category';
        render();
      }else{
        closeDrawer();
      }
    });

    // 検索
    queryI.addEventListener('input', ()=>{
      State.query = queryI.value || '';
      if(State.phase === 'category'){ renderCategoryGrid(); }
      else { renderSubcategoryGrid(); }
    });

    // 適用/クリア
    applyBtn.addEventListener('click', applyAndClose);
    clearBtn.addEventListener('click', clearSelection);

    // ========== ユーティリティ =======================================
    function escapeHtml(s){
      return String(s ?? '')
        .replaceAll('&','&amp;')
        .replaceAll('<','&lt;')
        .replaceAll('>','&gt;')
        .replaceAll('"','&quot;')
        .replaceAll("'",'&#39;');
    }

    /* =========== 参考：呼び出し側のサンプル実装（既存へ影響なし） =====
       既存の商品描画ロジックを触らず、categoryChangeイベントで
       Productsのフィルタ/再描画をかけてください。
       下の「例」はダミーです。あなたの既存関数に合わせて置換可。
    =================================================================== */
    window.addEventListener('ppp:categoryChange', (ev)=>{
      const { category, subcategory } = ev.detail || {};
      // 例：既存の loadProducts({categoryId, subcategoryId}) に委譲
      // loadProducts({ categoryId: category?.id ?? null, subcategoryId: subcategory?.id ?? null });
      console.log('categoryChange', category, subcategory);
    });

  })();
  </script>
</body>
</html>
