<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Ping-Pong-Pang｜翌日以降受け取り 注文</title>
<style>
:root{
  --bg:#fafafa;
  --ink:#1f2937;
  --muted:#6b7280;
  --brand:#10b981;
  --brand-ink:#064e3b;
  --border:#e5e7eb;
  --wrap:1080px;
  --btn-h:44px;
  --btn-radius:10px;
  --z-sticky:50;
}
*{box-sizing:border-box}
body{ margin:0; font-family:system-ui,-apple-system,"Segoe UI","Helvetica Neue",Arial,"Hiragino Sans","Noto Sans JP","Yu Gothic","Meiryo",sans-serif; color:var(--ink); background:#fff }
.wrap{ max-width:var(--wrap); width:100%; margin:0 auto; padding:0 16px }

/* ===== ヘッダー ===== */
header{ background:#fff; border-bottom:1px solid var(--border) }
.header-in{ display:flex; align-items:center; padding:12px 0 }
.brand{ font-size:20px; font-weight:800; text-indent:.4em; position:relative; white-space:nowrap; overflow:hidden; text-overflow:ellipsis }
.brand::before{ content:""; position:absolute; left:0; top:50%; transform:translateY(-50%); width:4px; height:1.2em; border-radius:2px; background:var(--brand) }

/* ===== メニューバー ===== */
.menubar{ position:sticky; top:0; z-index:var(--z-sticky); background:#fff; border-bottom:1px solid var(--border) }
.menubar-in{ display:flex; gap:8px; align-items:center; padding:10px 0 }
.menu-pill{
  font-size:13px; font-weight:700; color:#0f172a; background:#f1f5f9;
  border:1px solid #e2e8f0; border-radius:var(--btn-radius); padding:8px 12px; white-space:nowrap; cursor:pointer;
}
.menu-right{ margin-left:auto }

/* ▼ カテゴリボタンの動的ラベル＆クリア（PC/タブのみ表示） */
#btnCategories.has-filter{ padding-right:28px; position:relative; }
#btnCategories .tag{ font-weight:800; color:#0f172a }
#btnCategories .sep::before{ content:"›"; margin:0 4px; color:#94a3b8 }
#btnCategories .x{
  position:absolute; right:8px; top:50%; transform:translateY(-50%);
  width:20px; height:20px; border-radius:6px; border:1px solid #e5e7eb;
  display:grid; place-items:center; font-size:12px; cursor:pointer; background:#fff;
}
#btnCategories .x:active{ transform:translateY(-50%) translateY(1px) }
/* SP（〜420px）は常に固定文言・余白も通常化 */
@media (max-width:420px){
  #btnCategories{ padding-right:12px }
}

/* ===== 並べ替えオプションバー ===== */
.sortbar{ display:none; background:#fff; border-bottom:1px solid #eef2f7 }
.sortbar[aria-hidden="false"]{ display:block }
.sortbar-in{ max-width:var(--wrap); margin:0 auto; padding:8px 16px; display:flex; gap:8px; align-items:center; flex-wrap:wrap }
.sortbar .lbl{ font-size:12px; color:#64748b; margin-right:4px }
.sortbtn{
  font-size:12px; font-weight:800; color:#0f172a; background:#f8fafc;
  border:1px solid #e5e7eb; border-radius:999px; padding:6px 10px; cursor:pointer;
}
.sortbtn.active{ background:#e6f7f1; border-color:#bbf7d0; color:#065f46 }

/* ===== 商品カード ===== */
#productGrid.ppp-grid{ display:grid; grid-template-columns:repeat(2,540px); justify-content:space-between; gap:0 }
.ppp-card{ width:540px; background:#fff; border:1px solid var(--border); border-radius:16px; overflow:hidden }
.ppp-crumbrow{ display:block; padding:10px 12px 0 }
.ppp-crumb{ white-space:nowrap; overflow:hidden; text-overflow:ellipsis; color:#475569; font-size:12px }
.ppp-crumb a{ color:#0ea5e9; text-decoration:underline; text-underline-offset:2px; cursor:pointer }
.ppp-crumb a:hover{ color:#0284c7 } .ppp-crumb a:active{ opacity:.6 }
.ppp-titlebar{ display:flex; gap:8px; align-items:flex-start; padding:4px 12px 8px }
.ppp-name{ flex:1; font-weight:800; line-height:1.3; display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical; overflow:hidden }
.ppp-fav{ width:32px; height:32px; border-radius:8px; background:#fff; border:1px solid var(--border); display:grid; place-items:center; cursor:pointer }
.ppp-mi{ display:grid; grid-template-columns:minmax(160px,6fr) minmax(140px,4fr); column-gap:12px; align-items:start; padding:0 12px }
.ppp-mi > .ppp-media, .ppp-mi > .ppp-info { min-width:0 }
.ppp-img{ aspect-ratio:4/3; border:1px solid var(--border); border-radius:12px; overflow:hidden; background:#fff }
.ppp-img>img{ width:100%; height:100%; object-fit:contain; display:block }
.ppp-prenote{ background:#f8fafc; border:1px solid #e2e8f0; border-radius:8px; padding:6px 8px; font-size:13px; color:#334155; white-space:nowrap; overflow:hidden; text-overflow:ellipsis }
.ppp-price{ font-weight:900; font-size:22px }
.ppp-unit{ font-size:12px; color:#6b7280; text-align:right }
.ppp-actions{ display:grid; grid-template-columns:7fr 3fr; gap:8px; margin-bottom:10px }
.ppp-btn{ appearance:none; border:1px solid var(--border); background:#fff; border-radius:12px; cursor:pointer; font-weight:800; display:inline-flex; align-items:center; justify-content:center; height:var(--btn-h); white-space:nowrap; min-width:0; padding:0 12px; font-size:clamp(13px,1.6vw,16px) }
.ppp-btn.add{ background:var(--brand); color:#fff; border-color:transparent }
.ppp-btn.add:active{ transform:translateY(1px) }
.ppp-vars{ display:flex; flex-direction:column; gap:4px; margin-top:2px }
.ppp-pill{ width:100%; padding:6px 8px; border:1px solid var(--border); background:#fff; border-radius:10px; cursor:pointer; font-weight:700; font-size:13px }
.ppp-descwrap{ display:grid; grid-template-columns:1fr auto; gap:8px; align-items:end; padding:0 12px 12px }
.ppp-desc{ font-size:13px; color:#6b7280; line-height:1.5; min-height:calc(1.5 * 3 * 1em); display:-webkit-box; -webkit-line-clamp:3; -webkit-box-orient:vertical; overflow:hidden }
.ppp-more{ display:inline-flex; align-items:center; justify-content:center; text-decoration:none; color:#0ea5e9 }
.more--chev{ width:28px; height:28px; border-radius:8px; border:1px solid #e5e7eb; background:#fff }
.more--chev::before{ content:"›"; font-size:18px; line-height:1 } .more--chev:active{ transform: translateY(1px) }
@media(max-width:720px){ #productGrid.ppp-grid{ grid-template-columns:1fr; gap:12px } .ppp-card{ width:auto } }

/* ===== フッター（PC横一列／SP2行×3列） ===== */
.cart{ position:sticky; bottom:0; left:0; right:0; background:#fff; border-top:1px solid var(--border) }
.cart .wrap{ padding:0 16px }
.cart-box{ display:flex; align-items:center; gap:16px; justify-content:flex-end; padding:10px 0; padding-bottom:calc(10px + env(safe-area-inset-bottom)) }
.cart-left{ margin-right:auto; display:flex; align-items:center; gap:12px }
.inline-pill{ font-size:14px; background:#f0fdf4; color:var(--brand-ink); border:1px solid #d1fae5; border-radius:999px; padding:6px 14px; white-space:nowrap }
.count{ min-width:60px; text-align:right; font-size:14px }
.total{ min-width:80px; text-align:right; font-weight:900; font-size:18px }
.btn-cart{ background:var(--brand); color:#fff; border:none; border-radius:var(--btn-radius); padding:10px 18px; cursor:pointer; font-weight:800; white-space:nowrap }
.btn-cart:active{ transform:translateY(1px) }
@media(max-width:420px){
  .cart-box{ display:grid; grid-template-columns: 1fr 1fr auto; grid-template-rows: auto auto; gap:4px 12px; align-items:center; padding:6px 0; padding-bottom:calc(6px + env(safe-area-inset-bottom)) }
  .inline-pill{ display:none }
  .lbl-min{ grid-column:1; grid-row:1; font-size:12px; color:#065f46; opacity:.95 }
  .count{ grid-column:2; grid-row:1; text-align:right; font-weight:700 }
  .count::before{ content:"商品点数 "; font-size:12px; font-weight:600; opacity:.9; margin-right:4px }
  .val-date{ grid-column:1; grid-row:2; font-weight:700; font-size:14px; white-space:nowrap }
  .total{ grid-column:2; grid-row:2; text-align:right; font-size:17px }
  .total::before{ content:"合計金額 "; font-size:12px; font-weight:600; opacity:.9; margin-right:4px }
  .btn-cart{ grid-column:3; grid-row:1 / 3; align-self:stretch; padding:10px 14px; min-width:72px }
  .cart::after{ content:""; display:block; height:env(safe-area-inset-bottom); background:#fff }
}
@media(min-width:421px){ .val-date{ display:none } }

/* ===== カテゴリ選択ドロワー ===== */
.ppp-drawer{position:fixed;inset:0;z-index:4000;display:none}
.ppp-drawer[aria-hidden="false"]{display:block}
.ppp-drawer__scrim{position:absolute;inset:0;background:rgba(0,0,0,.18);opacity:0;transition:opacity .18s ease;z-index:0}
.ppp-drawer[aria-hidden="false"] .ppp-drawer__scrim{opacity:1}
.ppp-drawer__panel{position:absolute;top:0;right:0;height:100%;width:min(960px,92vw);background:#fff;box-shadow:-10px 0 24px rgba(0,0,0,.16);transform:translateX(100%);transition:transform .24s ease;display:grid;grid-template-rows:auto auto auto 1fr auto;overflow:hidden;padding-bottom:env(safe-area-inset-bottom);z-index:1}
.ppp-drawer[aria-hidden="false"] .ppp-drawer__panel{transform:translateX(0)}
.ppp-drawer__bar{ display:flex; align-items:center; gap:8px; padding:12px 14px; border-bottom:1px solid var(--border) }
.ppp-drawer__title{ font-weight:800; font-size:16px; flex:1 }
.ppp-iconbtn{ appearance:none; border:1px solid var(--border); background:#fff; border-radius:10px; padding:8px 10px; cursor:pointer }
.ppp-iconbtn:active{ transform:translateY(1px) }
.ppp-drawer__search{ padding:10px 14px; border-bottom:1px solid #f1f5f9 }
.ppp-input{ width:100%; font-size:16px; padding:10px 12px; border-radius:10px; border:1px solid var(--border); background:#fff }
.ppp-chips{ display:flex; gap:8px; flex-wrap:wrap; align-items:center; padding:8px 14px; border-bottom:1px dashed #eef2f7 }
.ppp-chip{ display:inline-flex; align-items:center; gap:6px; background:#f3f4f6; border:1px solid #e5e7eb; border-radius:999px; padding:6px 10px; font-size:12px }
.ppp-chip .x{ border:none; background:transparent; font-size:14px; line-height:1; cursor:pointer }
.ppp-listwrap{ overflow:auto; -webkit-overflow-scrolling:touch }
.ppp-listpad{ padding:10px 12px 16px }
.ppp-catgrid{ display:grid; grid-template-columns:repeat(2, minmax(0,1fr)); gap:8px }
@media (min-width:720px){ .ppp-catgrid{ grid-template-columns:repeat(3, minmax(0,1fr)) } }
@media (min-width:960px){ .ppp-catgrid{ grid-template-columns:repeat(4, minmax(0,1fr)) } }
.ppp-catgrid button{
  display:flex; align-items:center; justify-content:space-between; gap:8px;
  border:1px solid var(--border); background:#fff; border-radius:12px; padding:10px 12px;
  text-align:left; font-size:14px; position:relative; cursor:pointer;
}
.ppp-catgrid button .ttl{ flex:1; min-width:0; white-space:nowrap; overflow:hidden; text-overflow:ellipsis }
.ppp-catgrid button:active{ transform:translateY(1px) }
.ppp-drawer__footer{ display:flex; gap:10px; padding:10px 14px; border-top:1px solid var(--border); background:#fafafa }
.ppp-btn{ flex:1; appearance:none; border:1px solid var(--border); background:#fff; border-radius:12px; padding:12px 14px; font-weight:800; cursor:pointer }
.ppp-btn.primary{ background:var(--brand); color:#fff; border-color:transparent }
.ppp-btn.neutral{ background:#f3f4f6; border-color:#e5e7eb; color:#111827 }
.ppp-btn.neutral:hover{ background:#e5e7eb }

/* ドロワー表示中のページスクロール抑止 */
html.ppp-no-scroll, body.ppp-no-scroll{ overflow:hidden!important; touch-action:none!important }
</style>
</head>
<body>
<header>
  <div class="wrap header-in">
    <div class="brand">Ping-Pong-Pang</div>
  </div>
</header>

<main class="wrap">
  <section class="section">
    <h1 style="margin:.2em 0 0">翌日以降受取予約注文</h1>
    <p style="color:#6b7280; font-size:14px; margin:.3em 0 0">
      本ページは「取り置き予約（店頭受け取り）」の受付です。オンライン決済は行いません。お支払いは受け取り時に店頭にて。
    </p>
  </section>
</main>

<nav class="menubar">
  <div class="wrap menubar-in">
    <button class="menu-pill" id="btnAll">すべて</button>
    <button class="menu-pill" id="btnSort" aria-controls="sortbar" aria-expanded="false">並べ替え</button>
    <button class="menu-pill" id="btnCategories" aria-haspopup="dialog" aria-controls="catDrawer">カテゴリ</button>
    <div class="menu-right">
      <div id="menuRightAction" class="menu-pill">カートを見る</div>
    </div>
  </div>
</nav>

<!-- 並べ替えオプションバー -->
<div id="sortbar" class="sortbar" aria-hidden="true">
  <div class="sortbar-in">
    <div class="lbl">並べ替え:</div>
    <button class="sortbtn" data-sort="default">おすすめ</button>
    <button class="sortbtn" data-sort="price_asc">価格（安い順）</button>
    <button class="sortbtn" data-sort="price_desc">価格（高い順）</button>
    <button class="sortbtn" data-sort="popular">人気</button>
    <button class="sortbtn" data-sort="new">新着</button>
  </div>
</div>

<main class="wrap">
  <section id="productGrid" class="ppp-grid"></section>
  <section class="section">
    <p style="color:#9ca3af;font-size:13px;margin:24px 0 56px">
      写真はイメージ／価格は税込。入荷状況により数量調整のご相談をすることがあります。
    </p>
  </section>
</main>

<!-- ===== フッター ===== -->
<div class="cart" id="cartBar">
  <div class="wrap">
    <div class="cart-box">
      <div class="cart-left"><span class="inline-pill" id="cartMinDateInline">最短受取 —</span></div>
      <div class="lbl-min">最短受取日</div>
      <div class="count" id="cartCount">0点</div>
      <div class="val-date" id="cartMinDate">—</div>
      <div class="total" id="cartTotal">¥0</div>
      <button class="btn-cart" id="checkoutBtn2">カート</button>
    </div>
  </div>
</div>

<!-- ===== カテゴリ選択ドロワー ===== -->
<div id="catDrawer" class="ppp-drawer" aria-hidden="true" role="dialog" aria-modal="true">
  <div class="ppp-drawer__scrim"></div>
  <section class="ppp-drawer__panel" role="document" aria-labelledby="catDrawerTitle">
    <div class="ppp-drawer__bar">
      <button class="ppp-iconbtn" id="catDrawerBack" title="戻る" aria-label="戻る" style="visibility:hidden">←</button>
      <div class="ppp-drawer__title" id="catDrawerTitle">カテゴリを選ぶ</div>
      <button class="ppp-iconbtn" id="catDrawerClose" title="閉じる" aria-label="閉じる">✕</button>
    </div>
    <div class="ppp-drawer__search">
      <input id="catDrawerQuery" class="ppp-input" type="search" placeholder="カテゴリ名・サブカテゴリ名で絞り込み">
    </div>
    <div class="ppp-chips" id="catDrawerChips" aria-live="polite"></div>
    <div class="ppp-listwrap"><div class="ppp-listpad"><div id="catDrawerGrid" class="ppp-catgrid" role="list"></div></div></div>
    <div class="ppp-drawer__footer">
      <button id="catDrawerClear" class="ppp-btn neutral">クリア</button>
      <button id="catDrawerApply" class="ppp-btn primary">この条件で絞り込む</button>
    </div>
  </section>
</div>

<script>
/** ========= 設定 ========= **/
const PRODUCTS_URL="https://script.google.com/macros/s/AKfycbx-yCsl4gt8OvsP52llzlBmiWEW1JFyXAp3rmMRkKIll4r7IHO8hOiKO4dXoKgWAQJMTA/exec?endpoint=products";
const CUTOVER_HOUR = 2;
let PRODUCTS=[]; let productById=new Map();
const state={cart:{}, minDateISO:null};

/** ========= フィルタ状態 ========= **/
const filterState = { cat:null, subcat:null, sort:'default' };
const norm = (s)=> String(s||'').replace(/\s+/g,' ').trim().toLowerCase();

/** ========= SP判定（〜420px） ========= **/
const mqSP = window.matchMedia('(max-width: 420px)');
const isSP = () => mqSP.matches;

/** ========= カテゴリボタンのラベル更新（SPは常に固定） ========= **/
function updateCategoryButtonLabel(){
  const btn = document.getElementById('btnCategories');
  if(!btn) return;
  if(isSP()){ btn.classList.remove('has-filter'); btn.innerHTML='カテゴリ'; return; }
  const cat=filterState.cat||'', sub=filterState.subcat||'';
  if(!cat && !sub){ btn.classList.remove('has-filter'); btn.innerHTML='カテゴリ'; return; }
  btn.classList.add('has-filter');
  const label = sub ? `<span class="tag">${cat}</span><span class="sep"></span><span class="tag">${sub}</span>` : `<span class="tag">${cat}</span>`;
  btn.innerHTML = `カテゴリ: ${label}<span class="x" aria-label="条件クリア" title="条件クリア">×</span>`;
}

/** ========= カテゴリツリー ========= **/
function buildCatTree(){
  const map=new Map();
  (PRODUCTS||[]).forEach(p=>{
    const c=(p.catGroup||p.cat||'').trim(); if(!c) return;
    const s=(p.subcatGroup||'').trim();
    const k=norm(c);
    if(!map.has(k)) map.set(k,{label:c, subs:new Set()});
    if(s) map.get(k).subs.add(s);
  });
  const arr=[...map.values()].map(v=>({label:v.label, subs:[...v.subs]}));
  arr.sort((a,b)=>a.label.localeCompare(b.label,'ja')); arr.forEach(x=>x.subs.sort((a,b)=>a.localeCompare(b,'ja')));
  return arr;
}

/** ========= ユーティリティ ========= **/
function yen(n){ try{ return Number(n||0).toLocaleString('ja-JP',{style:'currency',currency:'JPY',maximumFractionDigits:0}); }catch(e){ return '¥'+(n||0); } }
function toJst(d=new Date()){ return new Date(new Intl.DateTimeFormat('en-US',{timeZone:'Asia/Tokyo'}).format(d)+' '+d.toTimeString().split(' ')[0]); }
function fmtJP(d){ const y=d.getFullYear(), m=d.getMonth()+1, day=d.getDate(); const w='日月火水木金土'[d.getDay()]; return `${y}/${String(m).padStart(2,'0')}/${String(day).padStart(2,'0')}(${w})`; }
function isoDate(d){ return d.toISOString().slice(0,10); }

/** ========= 並べ替えロジック ========= **/
function sortProducts(list){
  const s = filterState.sort || 'default';
  const byNum = (a,b)=> (a||0)-(b||0);
  const byNumDesc = (a,b)=> (b||0)-(a||0);
  switch(s){
    case 'price_asc':  return list.slice().sort((a,b)=>byNum(a.price,b.price));
    case 'price_desc': return list.slice().sort((a,b)=>byNumDesc(a.price,b.price));
    case 'popular':    return list.slice().sort((a,b)=>byNumDesc(a._pop,b._pop));            // ない場合は0で自然順
    case 'new':        return list.slice().sort((a,b)=>byNumDesc(a._newTS,b._newTS));        // ない場合は0
    default:           return list.slice().sort((a,b)=>a._idx-b._idx);                       // 元順
  }
}

/** ========= 最短受取・カート ========= **/
function calcMinDate(){ const now=toJst(); const base=new Date(now); if(now.getHours()<CUTOVER_HOUR){ base.setDate(base.getDate()-1); } const min=new Date(base); min.setDate(min.getDate()+1); min.setHours(0,0,0,0); return min; }
function renderMinDateEverywhere(){ const d=calcMinDate(); state.minDateISO=isoDate(d); const pill=document.getElementById('cartMinDateInline'); const sp=document.getElementById('cartMinDate'); if(pill)pill.textContent=`最短受取 ${fmtJP(d)}`; if(sp)sp.textContent=fmtJP(d); }
function totals(){ const ids=Object.keys(state.cart); let total=0,count=0; ids.forEach(id=>{ const p=productById.get(id); const q=Number(state.cart[id]||0); if(p&&q>0){ total+=(p.price||0)*q; count+=q; }}); return {total,count}; }
function renderCartBar(){ const t=totals(); const totalEl=document.getElementById('cartTotal'); const countEl=document.getElementById('cartCount'); if(totalEl) totalEl.textContent=yen(t.total); if(countEl) countEl.textContent=`${t.count}点`; }
function addToCart(p,qty){ const q=Number(state.cart[p.id]||0)+Number(qty||1); state.cart[p.id]=q; localStorage.setItem('cart',JSON.stringify(state.cart)); renderCartBar(); }

/** ========= 商品描画（フィルタ→並べ替え） ========= **/
function renderProducts(){
  const grid=document.getElementById('productGrid'); grid.className='ppp-grid'; grid.innerHTML='';
  const nCat=norm(filterState.cat), nSub=norm(filterState.subcat);
  const filtered=(PRODUCTS||[]).filter(p=>{
    if(p.active===false) return false;
    const pc=norm(p.catGroup||p.cat||''); const ps=norm(p.subcatGroup||'');
    if(nCat && pc!==nCat) return false; if(nSub && ps!==nSub) return false; return true;
  });
  const list = sortProducts(filtered);
  list.forEach(p=>{
    const soldout=(p.stock!==undefined&&Number(p.stock)<=0);
    const catLabel=p.catGroup||p.cat||''; const subcatLabel=p.subcatGroup||'';
    const crumbHTML=[ catLabel?`<a href="#" class="ppp-crumb-link" data-cat="${catLabel}">${catLabel}</a>`:'', subcatLabel?`<a href="#" class="ppp-crumb-link" data-subcat="${subcatLabel}">${subcatLabel}</a>`:'' ].filter(Boolean).join(' › ');
    const vars=[]; if(p.var1Id&&p.var1Label)vars.push({id:String(p.var1Id),label:p.var1Label}); if(p.var2Id&&p.var2Label)vars.push({id:String(p.var2Id),label:p.var2Label});
    const varsHTML=vars.slice(0,2).map(v=>`<button class="ppp-pill" data-var="${v.id}">${v.label}</button>`).join('');
    const el=document.createElement('article'); el.className='ppp-card'; el.dataset.id=p.id;
    el.innerHTML=`
      <div class="ppp-crumbrow"><div class="ppp-crumb">${crumbHTML}</div></div>
      <div class="ppp-titlebar"><div class="ppp-name">${p.name||''}</div><button class="ppp-fav" data-fav="${p.id}">♡</button></div>
      <div class="ppp-mi">
        <div class="ppp-media"><div class="ppp-img"><img src="${p.img||''}" alt="${p.name||''}" loading="lazy" decoding="async" referrerpolicy="no-referrer" onerror="this.onerror=null;this.src='https://dummyimage.com/1080x720/ffffff/e5e7eb&text=No+Image';"></div></div>
        <div class="ppp-info">
          ${p.prenote?`<div class="ppp-prenote">${p.prenote}</div>`:''}
          <div class="ppp-price">${(p.price>0&&!isNaN(p.price))?yen(p.price):'店頭価格'}</div>
          ${p.unitNote?`<div class="ppp-unit">${p.unitNote}</div>`:''}
          <div class="ppp-actions">
            <button class="ppp-btn add" data-add="${p.id}" ${soldout?'disabled':''} aria-label="カート追加"><span class="label">${soldout?'品切れ':'カート追加'}</span></button>
            <button class="ppp-btn" data-later="${p.id}">${localStorage.getItem('later:'+p.id)==='1'?'あとで済':'あとで'}</button>
          </div>
          ${varsHTML?`<div class="ppp-vars">${varsHTML}</div>`:''}
        </div>
      </div>
      <div class="ppp-descwrap" data-detail="${p.id}">
        <div class="ppp-desc">${p.desc||''}</div>
        <a class="ppp-more more--chev" href="#" data-detail="${p.id}" aria-label="詳しく"></a>
      </div>`;
    grid.appendChild(el);
  });
}

/** ========= データ読込 ========= **/
async function loadProducts(){
  try{
    const res=await fetch(PRODUCTS_URL,{cache:'no-store'}); const data=await res.json();
    PRODUCTS=(data.items||[]).map((x,i)=>({
      id:String(x.id||x.code||''), name:x.name, price:Number(x.price||0),
      img:x.img||x.imageUrl||'', desc:x.desc||'', prenote:x.prenote||'', unitNote:x.unitNote||'',
      catGroup:x.catGroup||x.cat||'', subcatGroup:x.subcatGroup||'',
      var1Id:x.var1Id||'', var1Label:x.var1Label||'', var2Id:x.var2Id||'', var2Label:x.var2Label||'',
      stock:(x.stock!==undefined?Number(x.stock):undefined),
      active:(x.active===undefined?true:Boolean(x.active)),
      leadDays:Number(x.leadDays||1),
      _idx:i,
      _pop:Number(x.popularity||x.pop||x.rank||0),
      _newTS: Date.parse(x.newAt||x.createdAt||x.updatedAt||x.date||'') || 0
    }));
    productById=new Map(PRODUCTS.map(p=>[p.id,p]));
    renderProducts(); updateCategoryButtonLabel(); renderSortActive();
  }catch(e){ console.error(e); }
}

/** ========= 並べ替えUI制御 ========= **/
const sortbar = document.getElementById('sortbar');
function toggleSortbar(show){
  const on = (show===undefined) ? sortbar.getAttribute('aria-hidden')==='true' : show;
  sortbar.setAttribute('aria-hidden', on?'false':'true');
  document.getElementById('btnSort')?.setAttribute('aria-expanded', on?'true':'false');
}
function renderSortActive(){
  document.querySelectorAll('.sortbtn').forEach(b=>{
    b.classList.toggle('active', b.dataset.sort===String(filterState.sort||'default'));
  });
}

/** ========= クリック系 ========= **/
document.addEventListener('click',ev=>{
  const add=ev.target.closest('.ppp-btn.add[data-add]'); if(add){ ev.preventDefault(); const p=productById.get(add.dataset.add); if(p) addToCart(p,1); }
  const later=ev.target.closest('.ppp-btn[data-later]'); if(later){ ev.preventDefault(); const key='later:'+later.dataset.later; const set=(localStorage.getItem(key)==='1'?'0':'1'); localStorage.setItem(key,set); later.textContent=set==='1'?'あとで済':'あとで'; }
  if(ev.target.closest('#menuRightAction')){ ev.preventDefault(); document.getElementById('cartBar')?.scrollIntoView({behavior:'smooth', block:'end'}); }
  if(ev.target.closest('#checkoutBtn2')){ ev.preventDefault(); const b=state.minDateISO; renderMinDateEverywhere(); const a=state.minDateISO; if(b&&a&&b!==a){ alert('最短受取日が更新されました：'+a.replaceAll('-','/')); } }

  // 並べ替えトグル
  if(ev.target.closest('#btnSort')){ ev.preventDefault(); toggleSortbar(); return; }
  // 並べ替え選択
  const sortBtn = ev.target.closest('.sortbtn[data-sort]');
  if(sortBtn){
    ev.preventDefault();
    filterState.sort = sortBtn.dataset.sort;
    renderSortActive();
    renderProducts();
    toggleSortbar(false);  // 自動で閉じる
    return;
  }
  // sortbar外クリックで閉じる
  if(sortbar.getAttribute('aria-hidden')==='false' && !ev.target.closest('#sortbar') && !ev.target.closest('#btnSort')){
    toggleSortbar(false);
  }

  // パンくずリンク（カード内）→ フィルタ
  const crumb = ev.target.closest('.ppp-crumb-link');
  if(crumb){
    ev.preventDefault();
    const cat=crumb.dataset.cat||null; const sub=crumb.dataset.subcat||null;
    if(cat){ filterState.cat=cat; filterState.subcat=null; }
    if(sub){ filterState.subcat=sub;
      if(!filterState.cat){
        const found=(PRODUCTS||[]).find(p=> norm(p.subcatGroup||'')===norm(sub));
        if(found) filterState.cat=found.catGroup||found.cat||null;
      }
    }
    updateCategoryButtonLabel();
    renderProducts();
    return;
  }

  // すべて
  if(ev.target.closest('#btnAll')){
    ev.preventDefault();
    filterState.cat=null; filterState.subcat=null;
    updateCategoryButtonLabel();
    renderProducts();
    return;
  }

  // カテゴリボタン → ドロワーOPEN（×を除く）
  if(ev.target.closest('#btnCategories') && !ev.target.closest('#btnCategories .x')){
    ev.preventDefault();
    openDrawer();
    return;
  }

  // カテゴリボタン内の × で条件クリア（PC/タブのみ表示）
  const clearX = ev.target.closest('#btnCategories .x');
  if(clearX){
    ev.preventDefault();
    filterState.cat=null; filterState.subcat=null;
    updateCategoryButtonLabel();
    renderProducts();
    return;
  }
});

/** ========= ドロワー制御 ========= **/
const drawer = document.getElementById('catDrawer');
document.querySelector('#catDrawer .ppp-drawer__scrim').addEventListener('click', (e)=>{ if(e.target.matches('.ppp-drawer__scrim')) closeDrawer(); });
const titleEl= document.getElementById('catDrawerTitle');
const backBtn= document.getElementById('catDrawerBack');
const queryI = document.getElementById('catDrawerQuery');
const chips  = document.getElementById('catDrawerChips');
const grid   = document.getElementById('catDrawerGrid');
function lockScroll(on){ document.documentElement.classList.toggle('ppp-no-scroll', on); document.body.classList.toggle('ppp-no-scroll', on); }
function openDrawer(){ drawer.setAttribute('aria-hidden','false'); lockScroll(true); titleEl.textContent='カテゴリを選ぶ'; backBtn.style.visibility='hidden'; chips.innerHTML=''; queryI.value=''; renderCategories(); setTimeout(()=>{ try{ queryI.focus({preventScroll:true}); }catch(_){} }, 30); window.addEventListener('keydown',onKeydown); }
function closeDrawer(){ drawer.setAttribute('aria-hidden','true'); lockScroll(false); window.removeEventListener('keydown',onKeydown); }
function onKeydown(e){ if(e.key==='Escape') closeDrawer(); }
document.getElementById('catDrawerClose').addEventListener('click', closeDrawer);
document.getElementById('catDrawerBack').addEventListener('click', ()=>{ titleEl.textContent='カテゴリを選ぶ'; backBtn.style.visibility='hidden'; renderCategories(); });
document.getElementById('catDrawerQuery').addEventListener('input', ()=>{ (backBtn.style.visibility==='hidden')?renderCategories():renderSubcats(CURRENT.cat?.label||''); });
document.getElementById('catDrawerClear').addEventListener('click', ()=>{ CURRENT={cat:null,sub:null}; filterState.cat=null; filterState.subcat=null; updateCategoryButtonLabel(); renderProducts(); closeDrawer(); });
document.getElementById('catDrawerApply').addEventListener('click', applyCurrentAndClose);
let CURRENT = { cat:null, sub:null };
function renderCategories(){ grid.innerHTML=''; const list=buildCatTreeCached(); const q=norm(queryI.value); const filtered=q?list.filter(c=>norm(c.label).includes(q)):list; if(!filtered.length){ grid.insertAdjacentHTML('beforeend','<div style="color:#9ca3af;font-size:13px;padding:16px">カテゴリが見つかりません</div>'); return; } filtered.forEach(c=>{ const btn=document.createElement('button'); btn.type='button'; btn.dataset.cat=c.label; btn.innerHTML=`<div class="ttl">${c.label}</div>`; btn.addEventListener('click',()=>{ CURRENT.cat={label:c.label}; CURRENT.sub=null; titleEl.textContent='サブカテゴリを選ぶ'; backBtn.style.visibility='visible'; queryI.value=''; renderSubcats(c.label); updateChips(); }); grid.appendChild(btn); }); }
function renderSubcats(catLabel){ grid.innerHTML=''; const any=document.createElement('button'); any.type='button'; any.dataset.cat=catLabel; any.dataset.sub=''; any.innerHTML=`<div class="ttl">すべて（${catLabel}）</div>`; any.addEventListener('click',()=>{ CURRENT.sub=null; updateChips(); }); grid.appendChild(any); const tree=buildCatTreeCached(); const cat=tree.find(x=> norm(x.label)===norm(catLabel)); const q=norm(queryI.value); const subs=(cat?.subs||[]).filter(s=>!q||norm(s).includes(q)); if(!subs.length){ grid.insertAdjacentHTML('beforeend','<div style="color:#9ca3af;font-size:13px;padding:16px">サブカテゴリが見つかりません</div>'); }else{ subs.forEach(s=>{ const btn=document.createElement('button'); btn.type='button'; btn.dataset.cat=catLabel; btn.dataset.sub=s; btn.innerHTML=`<div class="ttl">${s}</div>`; btn.addEventListener('click',()=>{ CURRENT.sub={label:s}; updateChips(); }); grid.appendChild(btn); }); } }
function updateChips(){ const parts=[]; if(CURRENT.cat) parts.push(`<span class="ppp-chip">${CURRENT.cat.label}<button class="x" data-x="cat" aria-label="カテゴリを外す">×</button></span>`); if(CURRENT.sub) parts.push(`<span class="ppp-chip">${CURRENT.sub.label}<button class="x" data-x="sub" aria-label="サブカテゴリを外す">×</button></span>`); chips.innerHTML=parts.join(''); chips.querySelectorAll('button[data-x]').forEach(b=>{ b.addEventListener('click',()=>{ const k=b.getAttribute('data-x'); CURRENT[k]=null; if(k==='cat'){ CURRENT.sub=null; titleEl.textContent='カテゴリを選ぶ'; backBtn.style.visibility='hidden'; renderCategories(); } else { renderSubcats(CURRENT.cat?.label||''); } updateChips(); }); }); }
function applyCurrentAndClose(){ filterState.cat = CURRENT.cat ? CURRENT.cat.label : null; filterState.subcat = CURRENT.sub ? CURRENT.sub.label : null; updateCategoryButtonLabel(); renderProducts(); closeDrawer(); }
function buildCatTreeCached(){ if(!buildCatTree._cache){ buildCatTree._cache=buildCatTree(); } return buildCatTree._cache; }

/** ========= 画面幅変化でSP/PC切替時のラベル再描画 ========= **/
mqSP.addEventListener?.('change', () => updateCategoryButtonLabel());

/** ========= 初期化 ========= **/
(function init(){
  try{ state.cart=JSON.parse(localStorage.getItem('cart')||'{}') }catch(_){}
  renderMinDateEverywhere(); renderCartBar(); loadProducts();
})();
</script>
</body>
</html>
