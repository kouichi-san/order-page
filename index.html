<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Ping-Pong-Pang｜翌日以降受け取り 注文</title>
<style>
:root{
  --bg:#fafafa;
  --ink:#1f2937;
  --muted:#6b7280;
  --brand:#10b981;
  --brand-ink:#064e3b;
  --border:#e5e7eb;
  --wrap:1080px;
  --btn-h:44px;
  --btn-radius:10px;
  --z-sticky:50;
}
*{box-sizing:border-box}
body{ margin:0; font-family:system-ui,-apple-system,"Segoe UI","Helvetica Neue",Arial,"Hiragino Sans","Noto Sans JP","Yu Gothic","Meiryo",sans-serif; color:var(--ink); background:#fff }
.wrap{ max-width:var(--wrap); width:100%; margin:0 auto; padding:0 16px }

/* ===== ヘッダー ===== */
header{ background:#fff; border-bottom:1px solid var(--border) }
.header-in{ display:flex; align-items:center; padding:12px 0 }
.brand{
  font-size:20px; font-weight:800; text-indent:.4em; position:relative; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
}
.brand::before{
  content:""; position:absolute; left:0; top:50%; transform:translateY(-50%);
  width:4px; height:1.2em; border-radius:2px; background:var(--brand);
}

/* ===== メニューバー ===== */
.menubar{ position:sticky; top:0; z-index:var(--z-sticky); background:#fff; border-bottom:1px solid var(--border) }
.menubar-in{ display:flex; gap:8px; align-items:center; padding:10px 0 }
.menu-btn{
  border:1px solid var(--border); background:#fff; border-radius:var(--btn-radius);
  padding:8px 12px; font-size:13px; font-weight:700; cursor:pointer; white-space:nowrap;
}
.menu-spacer{ flex:1 }
.menu-pill{
  font-size:13px; font-weight:700; color:#0f172a; background:#f1f5f9;
  border:1px solid #e2e8f0; border-radius:var(--btn-radius); padding:8px 12px; white-space:nowrap; cursor:pointer;
}

/* ===== 商品カード ===== */
#productGrid.ppp-grid{
  display:grid; grid-template-columns:repeat(2,540px);
  justify-content:space-between; gap:0;
}
.ppp-card{
  width:540px; background:#fff; border:1px solid var(--border);
  border-radius:16px; overflow:hidden;
}
.ppp-crumbrow{ display:block; padding:10px 12px 0 }
.ppp-crumb{ white-space:nowrap; overflow:hidden; text-overflow:ellipsis; color:#475569; font-size:12px }
.ppp-titlebar{ display:flex; gap:8px; align-items:flex-start; padding:4px 12px 8px }
.ppp-name{ flex:1; font-weight:800; line-height:1.3; display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical; overflow:hidden }
.ppp-fav{ width:32px; height:32px; border-radius:8px; background:#fff; border:1px solid var(--border); display:grid; place-items:center; cursor:pointer }
.ppp-mi{ display:grid; grid-template-columns:minmax(160px,6fr) minmax(140px,4fr); column-gap:12px; align-items:start; padding:0 12px }
.ppp-mi > .ppp-media, .ppp-mi > .ppp-info { min-width:0 }
.ppp-img{ aspect-ratio:4/3; border:1px solid var(--border); border-radius:12px; overflow:hidden; background:#fff }
.ppp-img>img{ width:100%; height:100%; object-fit:contain; display:block }
.ppp-prenote{ background:#f8fafc; border:1px solid #e2e8f0; border-radius:8px; padding:6px 8px; font-size:13px; color:#334155; white-space:nowrap; overflow:hidden; text-overflow:ellipsis }
.ppp-price{ font-weight:900; font-size:22px }
.ppp-unit{ font-size:12px; color:#6b7280; text-align:right }
.ppp-actions{ display:grid; grid-template-columns:7fr 3fr; gap:8px; margin-bottom:10px }
.ppp-btn{ appearance:none; border:1px solid var(--border); background:#fff; border-radius:12px; cursor:pointer; font-weight:800; display:inline-flex; align-items:center; justify-content:center; height:var(--btn-h); white-space:nowrap; min-width:0; padding:0 12px; font-size:clamp(13px,1.6vw,16px) }
.ppp-btn.add{ background:var(--brand); color:#fff; border-color:transparent }
.ppp-btn.add:active{ transform:translateY(1px) }
.ppp-vars{ display:flex; flex-direction:column; gap:4px; margin-top:2px }
.ppp-pill{ width:100%; padding:6px 8px; border:1px solid var(--border); background:#fff; border-radius:10px; cursor:pointer; font-weight:700; font-size:13px }
.ppp-descwrap{ display:grid; grid-template-columns:1fr auto; gap:8px; align-items:end; padding:0 12px 12px }
.ppp-desc{ font-size:13px; color:#6b7280; line-height:1.5; min-height:calc(1.5 * 3 * 1em); display:-webkit-box; -webkit-line-clamp:3; -webkit-box-orient:vertical; overflow:hidden }
.ppp-more{ display:inline-flex; align-items:center; justify-content:center; text-decoration:none; color:#0ea5e9 }
.more--chev{ width:28px; height:28px; border-radius:8px; border:1px solid #e5e7eb; background:#fff }
.more--chev::before{ content:"›"; font-size:18px; line-height:1 }
.more--chev:active{ transform: translateY(1px) }

@media(max-width:720px){
  #productGrid.ppp-grid{ grid-template-columns:1fr; gap:12px }
  .ppp-card{ width:auto }
}

/* ===== フッター（ベース：PC横一列） ===== */
.cart{ position:sticky; bottom:0; left:0; right:0; background:#fff; border-top:1px solid var(--border) }
.cart .wrap{ padding:0 16px }
.cart-box{
  display:flex; align-items:center; gap:16px;
  justify-content:flex-end;
  padding:10px 0; padding-bottom:calc(10px + env(safe-area-inset-bottom));
}
.cart-left{ margin-right:auto; display:flex; align-items:center; gap:12px }
.inline-pill{
  font-size:14px; background:#f0fdf4; color:var(--brand-ink);
  border:1px solid #d1fae5; border-radius:999px; padding:6px 14px; white-space:nowrap;
}
.count{ min-width:60px; text-align:right; font-size:14px }
.total{ min-width:80px; text-align:right; font-weight:900; font-size:18px }
.btn-cart{ background:var(--brand); color:#fff; border:none; border-radius:var(--btn-radius); padding:10px 18px; cursor:pointer; font-weight:800; white-space:nowrap }
.btn-cart:active{ transform:translateY(1px) }

/* ===== SP版フッター：2行×3列（上：最短受取日｜商品点数｜ボタン／下：日付｜合計金額｜） ===== */
@media(max-width:420px){
  .cart-box{
    display:grid;
    grid-template-columns: 1fr 1fr auto;   /* 左=最短受取 / 中=点数/合計 / 右=ボタン */
    grid-template-rows: auto auto;         /* 上=ラベル/値（点数） / 下=値（合計） */
    gap:4px 12px;                           /* 行間を詰めてスッキリ */
    align-items:center;
    padding:6px 0;
    padding-bottom:calc(6px + env(safe-area-inset-bottom));
  }
  /* PC用ピルはSPでは非表示 */
  .inline-pill{ display:none }

  /* 1段目（左/中のセル） */
  .lbl-min{ grid-column:1; grid-row:1; font-size:12px; color:#065f46; opacity:.95 }
  /* 商品点数は値を表示しつつ見出しも入れる */
  .count{ grid-column:2; grid-row:1; text-align:right; font-weight:700; }
  .count::before{ content:"商品点数 "; font-size:12px; font-weight:600; opacity:.9; margin-right:4px }

  /* 2段目（左=日付、 中=合計金額） */
  .val-date{ grid-column:1; grid-row:2; font-weight:700; font-size:14px; white-space:nowrap }
  .total{ grid-column:2; grid-row:2; text-align:right; font-size:17px }
  .total::before{ content:"合計金額 "; font-size:12px; font-weight:600; opacity:.9; margin-right:4px }

  /* カートボタンは上下2行ぶち抜きで常時表示 */
  .btn-cart{ grid-column:3; grid-row:1 / 3; align-self:stretch; padding:10px 14px; min-width:72px }

  /* safe-areaの黒帯と隙間を吸収 */
  .cart::after{ content:""; display:block; height:env(safe-area-inset-bottom); background:#fff }
}

/* === Category Drawer (right -> center) ================================== */
/* ドロワー本体（右→中央へスライド） */
.ppp-drawer{position:fixed;inset:0;z-index:4000;display:none}
.ppp-drawer[aria-hidden="false"]{display:block}
.ppp-drawer__scrim{position:absolute;inset:0;background:rgba(0,0,0,.35);opacity:0;transition:opacity .18s ease}
.ppp-drawer[aria-hidden="false"] .ppp-drawer__scrim{opacity:1}

.ppp-drawer__panel{
  position:absolute;top:0;right:0;height:100%;width:min(960px,92vw);
  background:#fff;color:inherit;box-shadow:-10px 0 24px rgba(0,0,0,.16);
  transform:translateX(100%);transition:transform .24s ease;
  display:grid;grid-template-rows:auto auto auto 1fr auto;overflow:hidden;
  padding-bottom:env(safe-area-inset-bottom);
}
.ppp-drawer[aria-hidden="false"] .ppp-drawer__panel{transform:translateX(0)}

.ppp-drawer__head,.ppp-drawer__foot{
  display:flex;align-items:center;gap:12px;padding:12px 16px;border-bottom:1px solid var(--border);background:#fff
}
.ppp-drawer__foot{border-top:1px solid var(--border);border-bottom:none;justify-content:flex-start}
.ppp-drawer__title{font-weight:700}

/* 検索・チップ */
.ppp-drawer__search{padding:8px 16px;border-bottom:1px solid #f5f5f5;background:#fff}
.ppp-drawer__search input{
  width:100%;height:40px;padding:0 12px;border:1px solid #ddd;border-radius:10px;outline:none
}
.ppp-drawer__search input:focus{border-color:#9ca3af}
.ppp-chips{display:flex;gap:8px;overflow:auto;padding:8px 16px;border-bottom:1px solid #f7f7f7;background:#fff}
.ppp-chips .chip{
  flex:0 0 auto;border:1px solid #ddd;border-radius:999px;padding:6px 10px;font-size:12px;background:#fff
}

/* 3+ 列カテゴリ・サブカテゴリ用グリッド（商品グリッド .ppp-grid と分離） */
.ppp-catgrid{
  padding:12px 16px;display:grid;gap:10px;grid-template-columns:repeat(3,1fr);
  overflow:auto;-webkit-overflow-scrolling:touch;background:#fff
}
@media (min-width:768px){ .ppp-catgrid{grid-template-columns:repeat(4,1fr)} }
@media (min-width:1100px){ .ppp-catgrid{grid-template-columns:repeat(6,minmax(128px,1fr))} }

.ppp-catgrid button{
  min-height:44px;border:1px solid #e6e6e6;border-radius:12px;padding:10px 12px;
  text-align:left;position:relative;background:#fff;cursor:pointer
}
.ppp-catgrid button:focus-visible{outline:2px solid rgba(0,122,255,.6);outline-offset:2px}
.ppp-catgrid .ttl{
  font-size:14px;line-height:1.25;max-height:2.5em;overflow:hidden;
  display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical
}
.ppp-catgrid .badge{position:absolute;top:6px;right:8px;font-size:11px;opacity:.75}

/* ドロワー内で使う補助 */
.ppp-btn.ghost{background:transparent} /* 既存 .ppp-btn を利用し「ghost」だけ追加 */
.ppp-link{border:none;background:none;color:#007aff;font:inherit;cursor:pointer}
.hidden{display:none!important}

/* 端末がアニメ減らす指定ならアニメ無効 */
@media (prefers-reduced-motion:reduce){
  .ppp-drawer__panel,.ppp-drawer__scrim{transition:none}
}

</style>
</head>
<body>
<header>
  <div class="wrap header-in">
    <div class="brand">Ping-Pong-Pang</div>
  </div>
</header>

<main class="wrap">
  <section class="section">
    <h1 style="margin:.2em 0 0">翌日以降受取予約注文</h1>
    <p style="color:#6b7280; font-size:14px; margin:.3em 0 0">
      本ページは「取り置き予約（店頭受け取り）」の受付です。オンライン決済は行いません。お支払いは受け取り時に店頭にて。
    </p>
  </section>
</main>

<nav class="menubar">
  <div class="wrap menubar-in">
    <button class="menu-btn">すべて</button>
    <button id="btnCat" class="menu-btn">カテゴリ</button>
    <button class="menu-btn">並べ替え</button>
    <div class="menu-spacer"></div>
    <div id="menuRightAction" class="menu-pill">カートを見る</div>
  </div>
</nav>

<!-- === Category Drawer (right -> center) === -->
<div id="catDrawer" class="ppp-drawer" role="dialog" aria-modal="true" aria-labelledby="catDrawerTitle" aria-hidden="true">
  <div class="ppp-drawer__panel" role="document">
    <div class="ppp-drawer__head">
      <button id="catDrawerClose" class="ppp-link" aria-label="閉じる" type="button">×</button>
      <div id="catDrawerTitle" class="ppp-drawer__title">カテゴリを選ぶ</div>
      <button id="catDrawerClear" class="ppp-link" type="button">クリア</button>
    </div>

    <div class="ppp-drawer__search">
      <input id="catDrawerQuery" type="search" placeholder="カテゴリ名やサブカテゴリ名を検索" autocomplete="off" />
    </div>

    <div id="catDrawerChips" class="ppp-chips" aria-live="polite"></div>

    <!-- グリッドは既存の .ppp-grid と衝突しないようクラス名を分離 -->
    <div id="catDrawerGrid" class="ppp-catgrid"></div>

    <div class="ppp-drawer__foot">
      <button id="catDrawerBack" class="ppp-btn ghost hidden" type="button">← カテゴリ一覧</button>
    </div>
  </div>

  <div class="ppp-drawer__scrim" tabindex="-1"></div>
</div>


<main class="wrap">
  <section id="productGrid" class="ppp-grid"></section>
  <section class="section">
    <p style="color:#9ca3af;font-size:13px;margin:24px 0 56px">
      写真はイメージ／価格は税込。入荷状況により数量調整のご相談をすることがあります。
    </p>
  </section>
</main>

<!-- ===== フッター（SP：2行×3列／PC：横一列） ===== -->
<div class="cart" id="cartBar">
  <div class="wrap">
    <div class="cart-box">
      <!-- PC用：左側に最短受取ピル（SPでは非表示） -->
      <div class="cart-left">
        <span class="inline-pill" id="cartMinDateInline">最短受取 —</span>
      </div>

      <!-- SP 1段目：最短受取日ラベル／点数（値＋ラベル） -->
      <div class="lbl-min">最短受取日</div>
      <div class="count" id="cartCount">0点</div>

      <!-- SP 2段目：日付（値）／合計金額（値＋ラベル） -->
      <div class="val-date" id="cartMinDate">—</div>
      <div class="total" id="cartTotal">¥0</div>

      <!-- 共通：カートボタン -->
      <button class="btn-cart" id="checkoutBtn2">カート</button>
    </div>
  </div>
</div>

<script>
/** ========= 設定 ========= **/
const PRODUCTS_URL="https://script.google.com/macros/s/AKfycbx-yCsl4gt8OvsP52llzlBmiWEW1JFyXAp3rmMRkKIll4r7IHO8hOiKO4dXoKgWAQJMTA/exec?endpoint=products";
const CUTOVER_HOUR = 2; // AM2:00で「翌日」表示に切替
let PRODUCTS=[]; let productById=new Map();
const state={cart:{}, minDateISO:null};

/** ========= ユーティリティ ========= **/
function yen(n){ try{ return Number(n||0).toLocaleString('ja-JP',{style:'currency',currency:'JPY',maximumFractionDigits:0}); }catch(e){ return '¥'+(n||0); } }
function toJst(d=new Date()){ return new Date(new Intl.DateTimeFormat('en-US',{timeZone:'Asia/Tokyo'}).format(d)+' '+d.toTimeString().split(' ')[0]); }
function fmtJP(d){ const y=d.getFullYear(), m=d.getMonth()+1, day=d.getDate(); const w='日月火水木金土'[d.getDay()]; return `${y}/${String(m).padStart(2,'0')}/${String(day).padStart(2,'0')}(${w})`; }
function isoDate(d){ return d.toISOString().slice(0,10); }

/** ========= 最短受取日ロジック（AM2:00切替） ========= **/
function calcMinDate(){
  const now = toJst();
  const base = new Date(now);
  if (now.getHours() < CUTOVER_HOUR){ base.setDate(base.getDate()-1); }
  const min = new Date(base); min.setDate(min.getDate()+1); min.setHours(0,0,0,0);
  return min;
}
function renderMinDateEverywhere(){
  const d = calcMinDate();
  state.minDateISO = isoDate(d);
  const labelPill = `最短受取 ${fmtJP(d)}`;
  const spDate = document.getElementById('cartMinDate');
  const pcPill = document.getElementById('cartMinDateInline');
  if (spDate) spDate.textContent = fmtJP(d); // SP下段：日付のみ
  if (pcPill) pcPill.textContent = labelPill; // PC横並び
}

/** ========= 合計・点数 ========= **/
function totals(){
  const ids=Object.keys(state.cart); let total=0; let count=0;
  ids.forEach(id=>{
    const p=productById.get(id); const qty=Number(state.cart[id]||0);
    if(p && qty>0){ total+=(p.price||0)*qty; count+=qty; }
  });
  return {total,count};
}
function renderCartBar(){
  const t=totals();
  const totalEl=document.getElementById('cartTotal');
  const countEl=document.getElementById('cartCount');
  if(totalEl) totalEl.textContent = yen(t.total);
  if(countEl)  countEl.textContent  = `${t.count}点`;
}

/** ========= カート操作 ========= **/
function addToCart(p,qty){
  const q=Number(state.cart[p.id]||0)+Number(qty||1);
  state.cart[p.id]=q;
  localStorage.setItem('cart',JSON.stringify(state.cart));
  renderCartBar();
}

/** ========= 商品描画 ========= **/
function renderProducts(){
  const grid=document.getElementById('productGrid');
  grid.className='ppp-grid'; grid.innerHTML='';
  (PRODUCTS||[]).filter(p=>p.active!==false).forEach(p=>{
    const soldout=(p.stock!==undefined&&Number(p.stock)<=0);
    const crumb=[p.catGroup,p.subcatGroup].filter(Boolean).join(' › ');
    const vars=[]; if(p.var1Id&&p.var1Label)vars.push({id:String(p.var1Id),label:p.var1Label});
                   if(p.var2Id&&p.var2Label)vars.push({id:String(p.var2Id),label:p.var2Label});
    const varsHTML=vars.slice(0,2).map(v=>`<button class="ppp-pill" data-var="${v.id}">${v.label}</button>`).join('');
    const el=document.createElement('article'); el.className='ppp-card'; el.dataset.id=p.id;
    el.innerHTML=`
      <div class="ppp-crumbrow"><div class="ppp-crumb">${crumb||''}</div></div>
      <div class="ppp-titlebar"><div class="ppp-name">${p.name||''}</div><button class="ppp-fav" data-fav="${p.id}">♡</button></div>
      <div class="ppp-mi">
        <div class="ppp-media">
          <div class="ppp-img"><img src="${p.img||''}" alt="${p.name||''}"
            loading="lazy" decoding="async" referrerpolicy="no-referrer"
            onerror="this.onerror=null;this.src='https://dummyimage.com/1080x720/ffffff/e5e7eb&text=No+Image';"></div>
        </div>
        <div class="ppp-info">
          ${p.prenote?`<div class="ppp-prenote">${p.prenote}</div>`:''}
          <div class="ppp-price">${(p.price>0&&!isNaN(p.price))?yen(p.price):'店頭価格'}</div>
          ${p.unitNote?`<div class="ppp-unit">${p.unitNote}</div>`:''}
          <div class="ppp-actions">
            <button class="ppp-btn add" data-add="${p.id}" ${soldout?'disabled':''} aria-label="カート追加">
              <span class="label">${soldout?'品切れ':'カート追加'}</span>
            </button>
            <button class="ppp-btn" data-later="${p.id}">${localStorage.getItem('later:'+p.id)==='1'?'あとで済':'あとで'}</button>
          </div>
          ${varsHTML?`<div class="ppp-vars">${varsHTML}</div>`:''}
        </div>
      </div>
      <div class="ppp-descwrap" data-detail="${p.id}">
        <div class="ppp-desc">${p.desc||''}</div>
        <a class="ppp-more more--chev" href="#" data-detail="${p.id}" aria-label="詳しく"></a>
      </div>`;
    grid.appendChild(el);
  });
}

/** ========= データ読込 ========= **/
async function loadProducts(){
  try{
    const res=await fetch(PRODUCTS_URL,{cache:'no-store'});
    const data=await res.json();
    PRODUCTS=(data.items||[]).map(x=>({
      id:String(x.id||x.code||''), name:x.name, price:Number(x.price||0),
      img:x.img||x.imageUrl||'', desc:x.desc||'', prenote:x.prenote||'', unitNote:x.unitNote||'',
      catGroup:x.catGroup||x.cat||'', subcatGroup:x.subcatGroup||'',
      var1Id:x.var1Id||'', var1Label:x.var1Label||'', var2Id:x.var2Id||'', var2Label:x.var2Label||'',
      stock:(x.stock!==undefined?Number(x.stock):undefined),
      active:(x.active===undefined?true:Boolean(x.active)), leadDays:Number(x.leadDays||1)
    }));
    productById=new Map(PRODUCTS.map(p=>[p.id,p]));
    renderProducts();
  }catch(e){ console.error(e); }
}

/** ========= イベント ========= **/
document.addEventListener('click',ev=>{
  const add=ev.target.closest('.ppp-btn.add[data-add]');
  if(add){ ev.preventDefault(); const p=productById.get(add.dataset.add); if(p) addToCart(p,1); }

  const later=ev.target.closest('.ppp-btn[data-later]');
  if(later){ ev.preventDefault();
    const key='later:'+later.dataset.later;
    const set=(localStorage.getItem(key)==='1'?'0':'1');
    localStorage.setItem(key,set);
    later.textContent=set==='1'?'あとで済':'あとで';
  }

  const menuCart=ev.target.closest('#menuRightAction');
  if(menuCart){ ev.preventDefault(); document.getElementById('cartBar')?.scrollIntoView({behavior:'smooth', block:'end'}); }

  const checkout=ev.target.closest('#checkoutBtn2');
  if(checkout){
    ev.preventDefault();
    const beforeISO=state.minDateISO;
    renderMinDateEverywhere(); // 進む直前に再チェック
    const afterISO=state.minDateISO;
    if(beforeISO && afterISO && beforeISO!==afterISO){
      alert('最短受取日が更新されました：' + afterISO.replaceAll('-','/'));
    }
    console.log('go to cart with minDate:', afterISO);
  }
},{passive:false});

/** ========= 初期化 ========= **/
(function init(){
  try{ state.cart=JSON.parse(localStorage.getItem('cart')||'{}') }catch(_){}
  renderMinDateEverywhere();   // 初期表示
  renderCartBar();             // 合計・点数
  loadProducts();              // 商品読み込み＆描画
})();
</script>

<script>
  // ← あなたの taxonomy GAS のデプロイURL（/exec まで）。末尾に ?endpoint=... を後で付けます
  const TAXONOMY_URL = 'https://script.google.com/macros/s/AKfycbwbZBWQHZ_mgWEooDV7bUoYJZAqgu88liGs9EyIhIxbaJFt5_8IS6Kk_eZYODm_xgNfVg/exec';

  // カテゴリ/サブカテゴリの状態（URL・保存と連携）
  const PPP_STATE = { cat: null, sub: null, sort: 'recommend' };

  // タクソノミーデータ & 件数（GASから取得）
  let PPP_TAXONOMY = null;  // { ok, categories:[], subcategories:{catId:[...]}, ... }
  let PPP_COUNTS   = null;  // { ok, catCount:{}, subCount:{} }

  // --- fetch（CORS失敗時はJSONPに自動フォールバック） ---
  async function fetchJson(url, timeoutMs=8000) {
    try {
      const ctrl = new AbortController();
      const t = setTimeout(()=>ctrl.abort(), timeoutMs);
      const res = await fetch(url, { signal: ctrl.signal, cache:'no-store' });
      clearTimeout(t);
      if (!res.ok) throw new Error('HTTP ' + res.status);
      return await res.json();
    } catch (e) {
      return await fetchJsonp(url, timeoutMs);
    }
  }
  function fetchJsonp(url, timeoutMs=8000) {
    return new Promise((resolve, reject)=>{
      const cb = 'jsonp_cb_' + Math.random().toString(36).slice(2);
      const timer = setTimeout(()=>{cleanup();reject(new Error('JSONP timeout'));}, timeoutMs);
      function cleanup(){ clearTimeout(timer); delete window[cb]; if (script && script.parentNode) script.parentNode.removeChild(script); }
      window[cb] = (data)=>{ cleanup(); resolve(data); };
      const script = document.createElement('script');
      script.src = url + (url.includes('?')?'&':'?') + 'callback=' + cb;
      script.onerror = ()=>{ cleanup(); reject(new Error('JSONP load error')); };
      document.head.appendChild(script);
    });
  }

  // --- URL / localStorage から状態を復元 ---
  function pppRestoreState(){
    const p = new URLSearchParams(location.search);
    const saved = localStorage.getItem('ppp_state');
    if (p.has('cat') || p.has('sub')) {
      PPP_STATE.cat  = p.get('cat') || null;
      PPP_STATE.sub  = p.get('sub') || null;
      PPP_STATE.sort = p.get('sort') || PPP_STATE.sort;
    } else if (saved) {
      try {
        const s = JSON.parse(saved);
        PPP_STATE.cat  = s.cat ?? null;
        PPP_STATE.sub  = s.sub ?? null;
        PPP_STATE.sort = s.sort ?? PPP_STATE.sort;
      } catch(_){}
    }
  }

  // --- 初期ロード：taxonomy と counts を並列取得（まだUIには繋げない）---
  async function pppInitTaxonomy(){
    try{
      const [tx, ct] = await Promise.all([
        fetchJson(`${TAXONOMY_URL}?endpoint=taxonomy`),
        fetchJson(`${TAXONOMY_URL}?endpoint=taxonomy_counts`)
      ]);
      if (tx && tx.ok) PPP_TAXONOMY = tx;
      if (ct && ct.ok) PPP_COUNTS   = ct;
      console.log('[taxonomy] loaded', {
        categories: PPP_TAXONOMY?.categories?.length ?? 0,
        subcatsKeys: PPP_TAXONOMY ? Object.keys(PPP_TAXONOMY.subcategories||{}).length : 0,
        hasCounts: !!PPP_COUNTS
      });
    } catch (e) {
      console.warn('taxonomy load failed', e);
    }
  }

  // --- 初期化フック（既存initとは独立） ---
  document.addEventListener('DOMContentLoaded', ()=>{
    pppRestoreState();
    pppInitTaxonomy();
  });

  // 戻る/進むでURLが変わったときに状態だけ復元（UI配線は次の手順で）
  window.addEventListener('popstate', ()=>{ pppRestoreState(); });

  // ドロワー実装で使う小ユーティリティ（後工程で使用）
  function esc(s){ return String(s).replace(/[&<>"]/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;' }[m])); }
</script>


</body>
</html>
