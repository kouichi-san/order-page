<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Ping-Pong-Pangï½œç¿Œæ—¥å—ã‘å–ã‚Š æ³¨æ–‡</title>
<style>
  :root{
    --bg:#fafafa; --ink:#1f2937; --muted:#6b7280; --brand:#0ea5e9; --border:#e5e7eb;
    --wrap:1080px; --btn-h:44px;
  }
  *{ box-sizing:border-box }
  body{ margin:0; font-family:system-ui,-apple-system,"Segoe UI","Helvetica Neue",Arial,"Hiragino Sans","Noto Sans JP","Yu Gothic","Meiryo",sans-serif; color:var(--ink); background:var(--bg) }
  .wrap{ max-width:var(--wrap); width:100%; margin:0 auto; padding:0 16px }

  header{ background:#fff; border-bottom:1px solid var(--border) }
  .header-in{ display:flex; gap:12px; align-items:center; padding:12px 0 }
  .brand{ font-size:20px; font-weight:800; letter-spacing:.01em }
  .tag{ font-size:12px; color:var(--muted) }
  .head-badge{ margin-left:auto; font-size:12px; background:#f1f5f9; color:#0f172a; border-radius:999px; padding:4px 10px; white-space:nowrap }

  .section{ padding:16px 0 }
  .lead{ color:var(--muted); font-size:14px }

  /* ===== å•†å“ã‚«ãƒ¼ãƒ‰ã‚°ãƒªãƒƒãƒ‰ ===== */
  #productGrid.ppp-grid{ display:grid; grid-template-columns:repeat(2,540px); justify-content:space-between; gap:0 }
  .ppp-card{ width:540px; background:#fff; border:1px solid var(--border); border-radius:16px; overflow:hidden }

  /* A) ãƒ‘ãƒ³ããšï¼ˆ1è¡Œãƒ»çœç•¥ï¼ãƒãƒƒã‚¸æ’¤å»ï¼‰ */
  .ppp-crumbrow{ display:block; padding:10px 12px 0 }
  .ppp-crumb{ white-space:nowrap; overflow:hidden; text-overflow:ellipsis; color:#475569; font-size:12px }

  /* B) ã‚¿ã‚¤ãƒˆãƒ«+ãŠæ°—ã«å…¥ã‚Š */
  .ppp-titlebar{ display:flex; gap:8px; align-items:flex-start; padding:4px 12px 8px }
  .ppp-name{ flex:1; font-weight:800; line-height:1.3; display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical; overflow:hidden }
  .ppp-fav{ width:32px; height:32px; border-radius:8px; background:#fff; border:1px solid var(--border); display:grid; place-items:center; cursor:pointer }

  /* C) ç”»åƒã¯æ¯”ç‡å¯å¤‰ã€‚SPã§ã‚‚INFOã‚’ä¸‹ã«å›ã‚Šè¾¼ã¾ã›ãšå¸¸ã«æ¨ªä¸¦ã³ */
  .ppp-mi{
    display:grid;
    grid-template-columns: minmax(160px, 6fr) minmax(140px, 4fr); /* 6:4 */
    column-gap:12px;
    align-items:start;
    padding:0 12px;
  }
  .ppp-mi > .ppp-media,
  .ppp-mi > .ppp-info { min-width:0; } /* æŠ¼ã—å‡ºã—é˜²æ­¢ */

  .ppp-img{ aspect-ratio:4/3; border:1px solid var(--border); border-radius:12px; overflow:hidden; background:#fff }
  .ppp-img>img{ width:100%; height:100%; object-fit:contain; display:block }

  .ppp-prenote{
    background:#f8fafc; border:1px solid #e2e8f0; border-radius:8px; padding:6px 8px;
    font-size:13px; color:#334155;
    white-space:nowrap; overflow:hidden; text-overflow:ellipsis; /* 1è¡Œå›ºå®š */
  }
  .ppp-price{ font-weight:900; font-size:22px }
  .ppp-unit{ font-size:12px; color:#6b7280; text-align:right }

  /* è¿½åŠ ï¼ã‚ã¨ã§ï¼š7:3ã€ä¸‹ã«ç©ºé–“ã‚’æ®‹ã™ */
  .ppp-actions{
    display:grid;
    grid-template-columns:7fr 3fr;
    gap:8px;
    margin-bottom:10px; /* â† ä¸‹ã«ä½™ç™½ã‚’ç¢ºä¿ */
  }
  .ppp-btn{
    appearance:none; border:1px solid var(--border); background:#fff; border-radius:12px; cursor:pointer; font-weight:800;
    display:inline-flex; align-items:center; justify-content:center; height:var(--btn-h); line-height:var(--btn-h);
    white-space:nowrap; overflow:hidden; text-overflow:ellipsis; min-width:0; padding:0 12px;
    font-size: clamp(13px, 1.6vw, 16px);
  }
  .ppp-btn.add{ background:var(--brand); color:#fff; border-color:transparent }

  /* ç‹­å¹…ã§ã®çŸ­ç¸®è¡¨ç¤ºï¼šğŸ›’ è¿½åŠ  â†’ æ¥µå°ã¯ã‚¢ã‚¤ã‚³ãƒ³ã®ã¿ï¼ˆaria-labelã§æ‹…ä¿ï¼‰ */
  @media (max-width: 420px){
    .ppp-btn.add::before{ content:"ğŸ›’"; display:inline-block; margin-right:.35em; }
    .ppp-btn.add .label{
      position:absolute; width:1px; height:1px; margin:-1px; padding:0; border:0; clip:rect(0 0 0 0); overflow:hidden;
    }
    .ppp-btn.add::after{ content:"è¿½åŠ "; }
  }
  @media (max-width: 340px){
    .ppp-btn.add::after{ content:""; }
  }

  /* ãƒãƒªã‚¨ãƒ¼ã‚·ãƒ§ãƒ³ï¼šç¸¦ç©ã¿ï¼†è¡Œé–“ã‚’è©°ã‚ã‚‹ */
  .ppp-vars{
    display:flex;
    flex-direction:column;
    gap:4px;          /* â† è¡Œé–“ã‚’è©°ã‚ã‚‹ */
    margin-top:2px;   /* actions ã¨ã®è·é›¢ã¯æœ€å°é™ */
  }
  .ppp-pill{
    width:100%;
    padding:6px 8px;  /* ã‚³ãƒ³ãƒ‘ã‚¯ãƒˆ */
    border:1px solid var(--border);
    background:#fff;
    border-radius:10px;
    cursor:pointer;
    font-weight:700;
    font-size:13px;
  }

  /* D) èª¬æ˜ï¼‹ãƒ‘ã‚¿ãƒ¼ãƒ³1ï¼ˆâ€ºã ã‘ã®ã‚¹ãƒãƒ¼ãƒˆãƒˆãƒªã‚¬ãƒ¼ï¼‰ */
  .ppp-descwrap{ display:grid; grid-template-columns:1fr auto; gap:8px; align-items:end; padding:0 12px 12px }
  .ppp-desc{ font-size:13px; color:#6b7280; line-height:1.5; min-height:calc(1.5 * 3 * 1em);
             display:-webkit-box; -webkit-line-clamp:3; -webkit-box-orient:vertical; overflow:hidden }

  .ppp-more{ display:inline-flex; align-items:center; justify-content:center; text-decoration:none; color:#0ea5e9; }
  .more--chev{ width:28px; height:28px; border-radius:8px; border:1px solid #e5e7eb; background:#fff }
  .more--chev::before{ content:"â€º"; font-size:18px; line-height:1; }
  .more--chev:active{ transform: translateY(1px); }

  /* ã‚«ãƒ¼ãƒ‰ã¯SPã§1åˆ—åŒ–ï¼ˆã‚«ãƒ¼ãƒ‰å†…ã¯å¸¸ã«2ã‚«ãƒ©ãƒ ç¶­æŒï¼‰ */
  @media(max-width:720px){
    #productGrid.ppp-grid{ grid-template-columns:1fr; justify-content:stretch; gap:12px }
    .ppp-card{ width:auto }
  }

  /* ä¸‹éƒ¨ã‚«ãƒ¼ãƒˆãƒãƒ¼ */
  .cart{ position:sticky; bottom:0; left:0; right:0; background:#0f172a; color:#fff; border-top:1px solid #111827 }
  .cart .wrap{ display:flex; gap:12px; align-items:center; padding:10px 16px; padding-bottom:calc(10px + env(safe-area-inset-bottom)) }
  .cart .pill{ font-size:12px; background:#111827; border:1px solid #1f2937; border-radius:999px; padding:6px 10px }
  .cart .spacer{ flex:1 }
  .cart .total{ font-weight:900; font-size:18px }
  .cart .btn{ background:#0ea5e9; color:#fff; border:none; border-radius:12px; padding:10px 16px; cursor:pointer; min-height:44px;
              white-space:nowrap; overflow:hidden; text-overflow:ellipsis }
</style>
</head>
<body>
<header>
  <div class="wrap header-in">
    <div class="brand">Ping-Pong-Pang</div>
    <div class="tag">ç¿Œæ—¥å—ã‘å–ã‚Š æ³¨æ–‡</div>
    <div class="head-badge">åº—é ­æ±ºæ¸ˆ / å–ç½®ãäºˆç´„</div>
  </div>
</header>

<main class="wrap">
  <section class="section">
    <h1 style="margin:.2em 0 0">ç¿Œæ—¥å—ã‘å–ã‚Š äºˆç´„æ³¨æ–‡</h1>
    <p class="lead">æœ¬ãƒšãƒ¼ã‚¸ã¯ã€Œå–ã‚Šç½®ãäºˆç´„ï¼ˆåº—é ­å—ã‘å–ã‚Šï¼‰ã€ã®å—ä»˜ã§ã™ã€‚ã‚ªãƒ³ãƒ©ã‚¤ãƒ³æ±ºæ¸ˆã¯è¡Œã„ã¾ã›ã‚“ã€‚ãŠæ”¯æ‰•ã„ã¯å—ã‘å–ã‚Šæ™‚ã«åº—é ­ã«ã¦ã€‚</p>
  </section>

  <section class="grid" id="productGrid"></section>

  <section class="section">
    <p style="color:#9ca3af;font-size:13px;margin:24px 0 56px">å†™çœŸã¯ã‚¤ãƒ¡ãƒ¼ã‚¸ï¼ä¾¡æ ¼ã¯ç¨è¾¼ã€‚å…¥è·çŠ¶æ³ã«ã‚ˆã‚Šæ•°é‡èª¿æ•´ã®ã”ç›¸è«‡ã‚’ã™ã‚‹ã“ã¨ãŒã‚ã‚Šã¾ã™ã€‚</p>
  </section>
</main>

<div class="cart" id="cartBar">
  <div class="wrap">
    <div id="cartCount" class="pill">0ç‚¹</div>
    <div id="cartMinDate" class="pill">æœ€çŸ­å—å– â€”</div>
    <div class="spacer"></div>
    <div class="total" id="cartTotal">Â¥0</div>
    <button class="btn" id="checkoutBtn2">æ³¨æ–‡ã¸é€²ã‚€</button>
  </div>
</div>

<script>
/* ===== è¨­å®š ===== */
const FORM_BASE="https://docs.google.com/forms/d/e/1FAIpQLScWyIhn4F9iS-ZFhHQlQerLu7noGWSu4xauMPgISh1DmNFD_w/viewform";
const ENTRY={customerName:"entry.1872572951",phone:"entry.823790426",pickup:"entry.1058935046",memo:"entry.2090841286",orderJson:"entry.1388699337",minPossible:"entry.1229502757"};
const CUTOFF_HOUR=20;
/* â† ã”è‡ªèº«ã®GAS Webã‚¢ãƒ—ãƒªURLã«ç½®ãæ›ãˆå¯ */
const PRODUCTS_URL="https://script.google.com/macros/s/AKfycbx-yCsl4gt8OvsP52llzlBmiWEW1JFyXAp3rmMRkKIll4r7IHO8hOiKO4dXoKgWAQJMTA/exec?endpoint=products";

let PRODUCTS=[]; let productById=new Map(); const state={cart:{}};

/* ===== util ===== */
function yen(n){ try{ return Number(n||0).toLocaleString('ja-JP',{style:'currency',currency:'JPY',maximumFractionDigits:0}); }catch(e){ return 'Â¥'+(n||0); } }
function totals(){
  const ids=Object.keys(state.cart); let total=0; const items=[];
  ids.forEach(id=>{
    const p=productById.get(id); const qty=Number(state.cart[id]||0);
    if(p && qty>0){ total += (p.price||0)*qty; items.push({code:p.id,name:p.name,qty,price:p.price}); }
  });
  return {total,items};
}
function renderCartBar(){
  const t=totals();
  document.getElementById('cartTotal').textContent=yen(t.total);
  document.getElementById('cartCount').textContent=`${t.items.reduce((a,b)=>a+b.qty,0)}ç‚¹`;
}
function addToCart(p,qty){
  const q=Number(state.cart[p.id]||0)+Number(qty||1);
  state.cart[p.id]=q; localStorage.setItem('cart',JSON.stringify(state.cart));
  renderCartBar();
}
try{ state.cart=JSON.parse(localStorage.getItem('cart')||'{}') }catch(e){ state.cart={} }

/* ===== render ===== */
function renderProducts(){
  const grid=document.getElementById('productGrid');
  grid.className='ppp-grid'; grid.innerHTML='';

  (PRODUCTS||[]).filter(p => p.active !== false).forEach(p=>{
    const soldout=(p.stock!==undefined && Number(p.stock)<=0);
    const crumb=[p.catGroup,p.subcatGroup].filter(Boolean).join(' â€º ');
    const vars=[]; if(p.var1Id&&p.var1Label) vars.push({id:String(p.var1Id),label:p.var1Label});
                   if(p.var2Id&&p.var2Label) vars.push({id:String(p.var2Id),label:p.var2Label});
    const varsHTML=vars.slice(0,2).map(v=>`<button class="ppp-pill" data-var="${v.id}">${v.label}</button>`).join('');

    const el=document.createElement('article');
    el.className='ppp-card'; el.setAttribute('data-id',p.id);

    el.innerHTML=`
      <!-- A) ãƒ‘ãƒ³ããšã®ã¿ï¼ˆ1è¡Œçœç•¥ï¼‰ -->
      <div class="ppp-crumbrow"><div class="ppp-crumb">${crumb||''}</div></div>

      <!-- B) ã‚¿ã‚¤ãƒˆãƒ«+ãŠæ°—ã«å…¥ã‚Š -->
      <div class="ppp-titlebar">
        <div class="ppp-name">${p.name||''}</div>
        <button class="ppp-fav" data-fav="${p.id}">â™¡</button>
      </div>

      <!-- C) ç”»åƒï¼ˆæ¯”ç‡å¯å¤‰ï¼‰ Ã— INFOï¼ˆå¸¸ã«æ¨ªä¸¦ã³ï¼‰ -->
      <div class="ppp-mi">
        <div class="ppp-media">
          <div class="ppp-img">
            <img src="${p.img||''}" alt="${p.name||''}"
                 loading="lazy" decoding="async" referrerpolicy="no-referrer"
                 onerror="this.onerror=null;this.src='https://dummyimage.com/1080x720/ffffff/e5e7eb&text=No+Image';">
          </div>
        </div>
        <div class="ppp-info">
          ${p.prenote?`<div class="ppp-prenote">${p.prenote}</div>`:''}
          <div class="ppp-price">${(p.price>0&&!isNaN(p.price))?yen(p.price):'åº—é ­ä¾¡æ ¼'}</div>
          ${p.unitNote?`<div class="ppp-unit">${p.unitNote}</div>`:''}
          <div class="ppp-actions">
            <button class="ppp-btn add" data-add="${p.id}" ${soldout?'disabled':''} aria-label="ã‚«ãƒ¼ãƒˆã«å…¥ã‚Œã‚‹"><span class="label">${soldout?'å“åˆ‡ã‚Œ':'ã‚«ãƒ¼ãƒˆã«å…¥ã‚Œã‚‹'}</span></button>
            <button class="ppp-btn" data-later="${p.id}">${localStorage.getItem('later:'+p.id)==='1'?'ã‚ã¨ã§æ¸ˆ':'ã‚ã¨ã§'}</button>
          </div>
          ${varsHTML?`<div class="ppp-vars">${varsHTML}</div>`:''}
        </div>
      </div>

      <!-- D) èª¬æ˜ï¼‹ãƒ‘ã‚¿ãƒ¼ãƒ³1ï¼ˆâ€ºã ã‘ã®ã‚¹ãƒãƒ¼ãƒˆãƒˆãƒªã‚¬ãƒ¼ï¼‰ -->
      <div class="ppp-descwrap" data-detail="${p.id}">
        <div class="ppp-desc">${p.desc||''}</div>
        <a class="ppp-more more--chev" href="#" data-detail="${p.id}" aria-label="è©³ã—ã"></a>
      </div>`;
    grid.appendChild(el);
  });
}

/* ===== data ===== */
async function loadProducts(){
  try{
    const res=await fetch(PRODUCTS_URL,{cache:'no-store'});
    const data=await res.json();
    PRODUCTS=(data.items||[]).map(x=>({
      id:String(x.id || x.code || ''),     // codeã§ã‚‚æ‹¾ã†
      name:x.name,
      price:Number(x.price||0),
      img:x.img || x.imageUrl || '',       // å …ç‰¢ã«
      desc:x.desc||'',
      prenote:x.prenote||'',
      unitNote:x.unitNote||'',
      catGroup:x.catGroup||x.cat||'',
      subcatGroup:x.subcatGroup||'',
      var1Id:x.var1Id||'', var1Label:x.var1Label||'',
      var2Id:x.var2Id||'', var2Label:x.var2Label||'',
      stock:(x.stock!==undefined?Number(x.stock):undefined),
      active:(x.active===undefined ? true : Boolean(x.active)), // æœªå®šç¾©ã¯è¡¨ç¤º
      leadDays:Number(x.leadDays||1)
    }));
    productById=new Map(PRODUCTS.map(p=>[p.id,p]));
    renderProducts();
  }catch(e){ console.error(e); }
}

/* ===== events ===== */
document.addEventListener('click',ev=>{
  // è¿½åŠ 
  const add=ev.target.closest('.ppp-btn.add[data-add]');
  if(add){ ev.preventDefault(); const p=productById.get(add.dataset.add); if(p) addToCart(p,1); }

  // ã‚ã¨ã§ãƒˆã‚°ãƒ«
  const later=ev.target.closest('.ppp-btn[data-later]');
  if(later){
    ev.preventDefault();
    const key='later:'+later.dataset.later;
    const set=(localStorage.getItem(key)==='1'?'0':'1');
    localStorage.setItem(key,set);
    later.textContent=set==='1'?'ã‚ã¨ã§æ¸ˆ':'ã‚ã¨ã§';
  }

  // ã‚‚ã£ã¨è¦‹ã‚‹ï¼ˆãƒ‰ãƒ­ãƒ¯ãƒ¼èµ·å‹•ãƒ•ãƒƒã‚¯ï¼‰
  const more=ev.target.closest('.ppp-more[data-detail]');
  if(more){
    ev.preventDefault();
    const pid = more.dataset.detail;
    // ã“ã“ã§å³â†’ä¸­å¤®ãƒ‰ãƒ­ãƒ¯ãƒ¼ã‚’é–‹ããƒãƒ³ãƒ‰ãƒ©ã«æ¥ç¶šï¼ˆåˆ¥å®Ÿè£…æƒ³å®šï¼‰
    console.log('open drawer for', pid);
  }
},{passive:false});

/* init */
loadProducts();
renderCartBar();
</script>
</body>
</html>
